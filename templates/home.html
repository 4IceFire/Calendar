{% extends 'base.html' %}

{% set page_title = 'Home' %}
{% block content %}
  <div class="row g-3">
    <div class="col-md-8">
      <p class="text-muted">Overview of what's happening right now.</p>

      <div class="tdeck-soft rounded-3 p-3">
        <div class="d-flex align-items-center gap-2">
          <img src="/static/tdeck-icon.svg" alt="" width="28" height="28" style="display:block">
          <div>
            <div class="h5 mb-0 tdeck-title">TDeck</div>
            <div class="small text-muted">Your Technical Director deck for cues, timers, and control.</div>
          </div>
        </div>
      </div>


      <div class="tdeck-soft rounded-3 p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Next 3 Triggers</h5>
          <button id="refresh-upcoming-triggers" class="btn btn-sm btn-outline-secondary">Refresh</button>
        </div>
        <div class="small text-muted mt-1" id="next-trigger-countdown">Loading...</div>
        <div class="list-group list-group-flush mt-2" id="next-triggers-list">
            <div class="list-group-item text-muted">Loading...</div>
          </div>
        </div>

      <div class="tdeck-soft rounded-3 p-3">
        <h5 class="mb-2">Event Times</h5>
        <div class="list-group list-group-flush">
          {% if event_times and event_times|length > 0 %}
            {% for ev in event_times %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="text-truncate">{{ ev.name }}</div>
                <div class="text-muted ms-2" style="white-space:nowrap">{{ ev.day }} {{ ev.time }}</div>
              </div>
            {% endfor %}
          {% else %}
            <div class="list-group-item text-muted">No events found</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-2">Health</h5>
        <div class="small text-muted" id="home-overview-updated"></div>
      </div>
      <div class="tdeck-soft rounded-3 p-3 small">
        <div class="d-flex flex-wrap gap-2">
          <div><span class="text-muted">Events:</span> <strong>{{ events_file or 'events.json' }}</strong></div>
          <div><span class="text-muted">Companion:</span> <strong>{{ companion_hostport or '127.0.0.1:8000' }}</strong></div>
          <div><span class="text-muted">ProPresenter:</span> <strong>{{ propresenter_hostport or '127.0.0.1:1025' }}</strong></div>
        </div>
      </div>

      <div class="mt-3">
        <h6 class="mb-2">Connections</h6>
        <div class="tdeck-soft rounded-3 overflow-hidden">
          <div class="list-group list-group-flush">
            <div class="list-group-item d-flex align-items-center gap-2">
              <span id="companion-dot-home" class="indicator-dot bg-danger"></span>
              <span id="companion-label-home">Companion: Checking...</span>
            </div>
            <div class="list-group-item d-flex align-items-center gap-2">
              <span id="propresenter-dot-home" class="indicator-dot bg-danger"></span>
              <span id="propresenter-label-home">ProPresenter: Checking...</span>
            </div>
            <div class="list-group-item d-flex align-items-center gap-2">
              <span id="videohub-dot-home" class="indicator-dot bg-danger"></span>
              <span id="videohub-label-home">VideoHub: Checking...</span>
            </div>
          </div>
        </div>
      </div>

      {% if not auth_enabled or can_access('page:timers') %}
        <div class="mt-3">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-2">Timers</h6>
            <a class="btn btn-sm btn-outline-secondary" href="/timers">Open</a>
          </div>
          <div class="tdeck-soft rounded-3 p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-truncate">
                <div class="small text-muted">Last preset pressed</div>
                <div class="fw-semibold text-truncate" id="home-timer-last-label">â€”</div>
              </div>
              <button class="btn btn-sm btn-primary" id="home-timer-last-apply" disabled>Apply</button>
            </div>
            <hr class="my-2">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-truncate">
                <div class="small text-muted">Next preset</div>
                <div class="fw-semibold text-truncate" id="home-timer-next-label">â€”</div>
              </div>
              <button class="btn btn-sm btn-outline-primary" id="home-timer-next-apply" disabled>Apply</button>
            </div>
            <div class="small text-danger mt-2" id="home-timer-error" style="display:none"></div>
          </div>
        </div>
      {% endif %}

      {% if not auth_enabled or can_access('page:videohub') %}
        <div class="mt-3">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-2">VideoHub</h6>
            <a class="btn btn-sm btn-outline-secondary" href="/videohub">Open</a>
          </div>
          <div class="tdeck-soft rounded-3 p-3">
            <div class="small text-muted">Latest preset applied</div>
            <div class="fw-semibold text-truncate" id="home-videohub-last">â€”</div>
            <div class="small text-muted" id="home-videohub-last-meta"></div>
          </div>
        </div>
      {% endif %}


    </div>
  </div>

  <script>
  (function(){
    const listEl = document.getElementById('next-triggers-list');
    const countdownEl = document.getElementById('next-trigger-countdown');
    const refreshBtn = document.getElementById('refresh-upcoming-triggers');
    let current = [];
    let tickHandle = null;
    let lastFetchAt = 0;

    function pad2(n){ return String(n).padStart(2,'0'); }
    function formatDateDMY(ms){
      try{
        const d = new Date(ms);
        const dd = pad2(d.getDate());
        const mm = pad2(d.getMonth() + 1);
        const yy = pad2(d.getFullYear() % 100);
        return `${dd}/${mm}/${yy}`;
      }catch(e){
        return '';
      }
    }
    function formatDuration(seconds){
      const s = Math.max(0, Math.floor(seconds));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const ss = s % 60;
      if(h > 0) return `${h}:${pad2(m)}:${pad2(ss)}`;
      return `${m}:${pad2(ss)}`;
    }
    function formatDue(ms){
      try{
        const d = new Date(ms);
        const date = formatDateDMY(ms);
        const time = d.toLocaleString(undefined, {weekday:'short', hour:'2-digit', minute:'2-digit', second:'2-digit'});
        return date ? `${date} ${time}` : time;
      }catch(e){
        return '';
      }
    }
    function prettyApiPath(p){
      const s = String(p || '').trim();
      return s.startsWith('/api/') ? s.slice(4) : s;
    }
    function render(){
      if(!Array.isArray(current) || current.length === 0){
        countdownEl.textContent = 'No upcoming triggers found';
        listEl.innerHTML = '<div class="list-group-item text-muted">No upcoming triggers</div>';
        return;
      }

      const next = current[0];
      const secs = (next.due_ms - Date.now()) / 1000;
      countdownEl.textContent = `Next trigger in ${formatDuration(secs)} (${formatDue(next.due_ms)})`;

      listEl.innerHTML = '';
      current.slice(0,3).forEach((t)=>{
        const actionType = (t.actionType || 'companion');
        const button = (actionType === 'api')
          ? `API: ${(t.api && t.api.method) ? String(t.api.method).toUpperCase() : 'POST'} ${t.api && t.api.path ? prettyApiPath(t.api.path) : ''}`
          : ((t.button && (t.button.label || t.button.pattern))
            ? `${t.button.label ? t.button.label + ' â€” ' : ''}${t.button.pattern || ''}`
            : (t.buttonURL || ''));
        const name = String((t && t.name) ? t.name : '').trim() || button || '';
        const row = document.createElement('div');
        row.className = 'list-group-item d-flex justify-content-between align-items-center';
        row.innerHTML = `
          <div class="text-truncate">
            <div class="fw-semibold text-truncate">${t.event || '(unnamed)'} <span class="text-muted">(${t.offset || ''})</span></div>
            <div class="small text-muted text-truncate">${name}</div>
          </div>
          <div class="text-muted ms-2" style="white-space:nowrap">${formatDue(t.due_ms)}</div>
        `;
        listEl.appendChild(row);
      });
    }

    function startTick(){
      if(tickHandle) return;
      tickHandle = setInterval(()=>{
        if(!Array.isArray(current) || current.length === 0) return;
        const next = current[0];
        const secsLeft = (next.due_ms - Date.now()) / 1000;
        if(secsLeft <= 0){
          // refresh soon after a trigger time passes
          fetchUpcoming(true);
        }else{
          countdownEl.textContent = `Next trigger in ${formatDuration(secsLeft)} (${formatDue(next.due_ms)})`;
        }
      }, 1000);
    }

    async function fetchUpcoming(force){
      const now = Date.now();
      if(!force && (now - lastFetchAt) < 3000) return; // basic debounce
      lastFetchAt = now;
      try{
        const resp = await fetch('/api/upcoming_triggers?_ts=' + Date.now(), {cache:'no-store'});
        if(!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        current = Array.isArray(data.triggers) ? data.triggers : [];
        render();
        startTick();
      }catch(e){
        console.error(e);
        countdownEl.textContent = 'Unable to load upcoming triggers';
        listEl.innerHTML = '<div class="list-group-item text-muted">Unable to load</div>';
      }
    }

    if(refreshBtn){ refreshBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); fetchUpcoming(true); }); }
    fetchUpcoming(true);
    // periodic refresh to keep list accurate across changes
    setInterval(()=>fetchUpcoming(false), 15000);
  })();
  </script>

  <script>
  (function(){
    const updatedEl = document.getElementById('home-overview-updated');

    const lastLabel = document.getElementById('home-timer-last-label');
    const nextLabel = document.getElementById('home-timer-next-label');
    const lastBtn = document.getElementById('home-timer-last-apply');
    const nextBtn = document.getElementById('home-timer-next-apply');
    const timerErr = document.getElementById('home-timer-error');
    const vhLast = document.getElementById('home-videohub-last');
    const vhMeta = document.getElementById('home-videohub-last-meta');

    let lastPresetNum = null;
    let nextPresetNum = null;
    let refreshing = false;

    function formatAgo(ts){
      if(!ts) return '';
      const t = Number(ts);
      if(!Number.isFinite(t) || t <= 0) return '';
      const ms = Date.now() - Math.floor(t * 1000);
      const s = Math.max(0, Math.floor(ms / 1000));
      if(s < 5) return 'just now';
      if(s < 60) return `${s}s ago`;
      const m = Math.floor(s / 60);
      if(m < 60) return `${m}m ago`;
      const h = Math.floor(m / 60);
      return `${h}h ago`;
    }

    function setTimerError(msg){
      if(!timerErr) return;
      const s = String(msg || '').trim();
      if(!s){ timerErr.style.display = 'none'; timerErr.textContent = ''; return; }
      timerErr.style.display = '';
      timerErr.textContent = s;
    }

    function fmtPreset(p){
      if(!p) return 'â€”';
      const n = (p.preset != null) ? `#${p.preset}` : '';
      const name = String(p.name || '').trim();
      const t = String(p.time || '').trim();
      const label = name && t && name !== t ? `${name} (${t})` : (name || t || '');
      return n && label ? `${n} â€” ${label}` : (label || n || 'â€”');
    }

    async function applyPreset(presetNumber){
      const n = Number(presetNumber);
      if(!Number.isFinite(n) || n <= 0) return;
      setTimerError('');
      try{
        if(lastBtn) lastBtn.disabled = true;
        if(nextBtn) nextBtn.disabled = true;
        const res = await fetch('/api/timers/apply', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({preset: n}),
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || !data.ok){
          throw new Error(data.error || `Apply failed (HTTP ${res.status})`);
        }
        await refresh(true);
      }catch(e){
        setTimerError(String((e && e.message) || e || 'Apply failed'));
      }finally{
        // Buttons will be updated by refresh(); keep safe fallback.
        if(lastBtn && lastPresetNum == null) lastBtn.disabled = true;
        if(nextBtn && nextPresetNum == null) nextBtn.disabled = true;
      }
    }

    async function refresh(force){
      if(refreshing) return;
      refreshing = true;
      try{
        const res = await fetch('/api/home/overview?_ts=' + Date.now(), {cache:'no-store'});
        const data = await res.json().catch(()=>({}));
        if(!res.ok || !data.ok) throw new Error(data.error || 'Failed to load overview');

        if(updatedEl){
          try{
            updatedEl.textContent = 'Updated ' + (new Date()).toLocaleTimeString();
          }catch(e){
            updatedEl.textContent = '';
          }
        }

        const timers = data.timers || {};
        const last = timers.last || null;
        const next = timers.next || null;
        lastPresetNum = last ? last.preset : null;
        nextPresetNum = next ? next.preset : null;

        if(lastLabel) lastLabel.textContent = fmtPreset(last);
        if(nextLabel) nextLabel.textContent = fmtPreset(next);

        if(lastBtn){
          lastBtn.disabled = !(lastPresetNum != null);
        }
        if(nextBtn){
          nextBtn.disabled = !(nextPresetNum != null);
        }

        const vh = data.videohub || {};
        const vhLastObj = vh.last || null;
        const vhRoute = vh.route || null;
        if(vhLast){
          if(vhLastObj){
            vhLast.textContent = String(vhLastObj.name || `Preset #${vhLastObj.id}`);
          }else if(vhRoute && vhRoute.output != null && vhRoute.input != null){
            const m = vhRoute.monitor ? ' (monitor)' : '';
            vhLast.textContent = `Route: Out ${vhRoute.output} â†’ In ${vhRoute.input}${m}`;
          }else{
            vhLast.textContent = 'â€”';
          }
        }
        if(vhMeta){
          const idTxt = (vhLastObj && vhLastObj.id != null) ? `ID: ${vhLastObj.id}` : '';
          const ago = formatAgo(vh.last_ts);
          const routeAgo = formatAgo(vh.route_ts);
          if(vhLastObj){
            vhMeta.textContent = (idTxt && ago) ? `${idTxt} â€¢ ${ago}` : (idTxt || ago || '');
          }else if(vhRoute){
            vhMeta.textContent = routeAgo ? routeAgo : '';
          }else{
            vhMeta.textContent = '';
          }
        }
      }catch(e){
        // Don't spam errors; only show timer error if timer widgets exist.
        if(timerErr) setTimerError(String((e && e.message) || e || 'Unable to load overview'));
      }finally{
        refreshing = false;
      }
    }

    if(lastBtn){
      lastBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); applyPreset(lastPresetNum); });
    }
    if(nextBtn){
      nextBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); applyPreset(nextPresetNum); });
    }

    refresh(true);
    setInterval(()=>refresh(false), 5000);
  })();
  </script>
{% endblock %}


