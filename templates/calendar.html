{% extends 'base.html' %}

{% set page_title = 'Schedule' %}
{% set page_subtitle = 'List of scheduled events.' %}

{% block page_actions %}
  <button id="refresh-events" class="btn btn-sm btn-outline-secondary">Refresh</button>
  <button id="add-event" class="btn btn-sm btn-primary">Add Event</button>
  <a href="/calendar/triggers" class="btn btn-sm btn-outline-secondary">Upcoming Triggers</a>
  <a href="/templates" class="btn btn-sm btn-outline-secondary">Templates</a>
{% endblock %}

{% block content %}

<div class="tdeck-soft rounded-3 p-3">
  <div class="table-responsive tdeck-table-wrap">
    <table class="table table-sm table-hover align-top tdeck-table mb-0">
      <thead>
        <tr>
          <th style="width:70px">ID</th>
          <th style="min-width:220px">Name</th>
          <th style="width:140px">Date</th>
          <th style="width:110px">Time</th>
          <th style="width:100px">Repeating</th>
          <th style="width:90px">Active</th>
          <th>Triggers</th>
          <th class="text-end" style="width:170px"></th>
        </tr>
      </thead>
      <tbody id="events-body">
        <tr><td colspan="8" class="text-center text-muted">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
async function loadEvents(){
  const tbody = document.getElementById('events-body');
  tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Loading…</td></tr>';
  try{
    // fetch events and templates so we can display template labels when available
    const [resp, tplResp] = await Promise.all([
      fetch('/api/ui/events?_ts=' + Date.now(), {cache: 'no-store'}),
      fetch('/api/templates?_ts=' + Date.now(), {cache: 'no-store'})
    ]);
    const data = await resp.json();
    // cache for action handlers (e.g. Save Template)
    try{ window.__calendarEvents = Array.isArray(data) ? data : []; }catch(e){}
    const tplData = await tplResp.json().catch(()=>({buttons:[]}));
    const buttons = Array.isArray(tplData.buttons) ? tplData.buttons : [];
    // build mapping of buttonURL and short-pattern -> label
    const btnMap = {};
    for(const b of buttons){
      const bu = b.buttonURL || (b.pattern ? `location/${b.pattern}/press` : null);
      if(!bu) continue;
      btnMap[bu] = b.label;
      // also map the short form if possible
      const m = bu.match(/^location\/(\d+\/\d+\/\d+)\/press$/);
      if(m && m[1]) btnMap[m[1]] = b.label;
    }
    if(!Array.isArray(data) || data.length===0){
      tbody.innerHTML = '<tr><td colspan="8" class="text-center">No events</td></tr>';
      return;
    }
    tbody.innerHTML = '';
    function friendlyTriggerParts(t){
      const rawType = String(t.typeOfTrigger || '').toUpperCase();
      const mins = Number(t.minutes) || 0;

      const actionType = String(t.actionType || 'companion').toLowerCase();

      // Represent BEFORE/AT/AFTER as a signed offset so it reads at-a-glance.
      // BEFORE => -Xm, AT => 0m, AFTER => +Xm
      let sign = '';
      if (rawType === 'BEFORE') sign = '-';
      else if (rawType === 'AFTER') sign = '+';
      else sign = '';
      const offsetLabel = `${sign}${mins}m`;

      if(actionType === 'api'){
        const m = (t.api && t.api.method) ? String(t.api.method).toUpperCase() : 'POST';
        const rawP = (t.api && t.api.path) ? String(t.api.path) : '';
        const p = rawP.startsWith('/api/') ? rawP.slice(4) : rawP;
        return {
          rawType,
          offsetLabel,
          target: `API: ${m} ${p}`,
          targetKind: 'api',
        };
      }

      // normalize short and full button forms
      const raw = t.buttonURL || '';
      let shortBtn = '';
      try{
        const m = /([0-9]+\/[0-9]+\/[0-9]+)/.exec(raw || '');
        if(m && m[1]) shortBtn = m[1];
        else {
          const parts = (raw || '').split('/').filter(Boolean);
          if(parts.length >= 3) shortBtn = parts.slice(-3).join('/');
          else shortBtn = raw || '';
        }
      }catch(e){ shortBtn = raw || ''; }

      const fullBtn = /^location\/.+/.test(raw) ? raw : ( /^\d+\/\d+\/\d+$/.test(shortBtn) ? `location/${shortBtn}/press` : shortBtn );

      // prefer showing a template label when available
      const label = btnMap[fullBtn] || btnMap[shortBtn];
      const target = label ? String(label) : (shortBtn ? String(shortBtn) : '');
      return {
        rawType,
        offsetLabel,
        target,
        targetKind: label ? 'template' : (shortBtn ? 'button' : ''),
      };
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    for(const e of data){
      const tr = document.createElement('tr');
      const triggers = Array.isArray(e.times) ? e.times : [];
      const triggerRows = triggers.map(t => {
        const isEnabled = (t && t.enabled !== false);
        const parts = friendlyTriggerParts(t);
        const target = parts.target || '';
        const typeCls = parts.rawType ? `cal-trigger-${String(parts.rawType).toLowerCase()}` : '';
        const targetCls = parts.targetKind ? `cal-trigger-${parts.targetKind}` : '';
        const disabledCls = isEnabled ? '' : 'opacity-50';
        const off = isEnabled ? '' : ' (off)';
        return `
          <div class="cal-trigger-row ${disabledCls}">
            <span class="cal-trigger-offset ${typeCls}">${escapeHtml(parts.offsetLabel || '')}</span>
            <span class="cal-trigger-target ${targetCls}">${escapeHtml(target + off)}</span>
          </div>
        `;
      }).join('');
      const triggersHtml = triggerRows ? `<div class="cal-triggers">${triggerRows}</div>` : '';
      tr.innerHTML = `
        <td>${e.id ?? ''}</td>
        <td>${e.name}</td>
        <td>${e.date}</td>
        <td>${e.time}</td>
        <td>${e.repeating ? 'Yes' : 'No'}</td>
        <td>${e.active ? 'Yes' : 'No'}</td>
        <td>${triggersHtml}</td>
        <td>
          <div class="btn-group" role="group">
            <button class="btn btn-sm btn-outline-success save-template" data-id="${e.id}">Save Template</button>
            <button class="btn btn-sm btn-outline-primary edit-event" data-id="${e.id}">Edit</button>
            <button class="btn btn-sm btn-outline-danger delete-event" data-id="${e.id}">Delete</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }catch(err){
    tbody.innerHTML = `<tr><td colspan="8" class="text-danger">Error loading events</td></tr>`;
    console.error(err);
  }
}

document.getElementById('refresh-events').addEventListener('click', loadEvents);

// Add event button (placeholder: navigate to a create page or open editor)
document.getElementById('add-event').addEventListener('click', async ()=>{
  // TODO: replace with a proper create-event flow / modal
  try{
    window.location.href = '/calendar/new';
  }catch(e){console.error(e)}
});

// Delegate edit/delete button handlers
document.getElementById('events-body').addEventListener('click', async (ev) => {
  const btn = ev.target.closest('button');
  if(!btn) return;
  if(btn.classList.contains('save-template')){
    const id = btn.getAttribute('data-id');
    if(!id) return;
    const events = Array.isArray(window.__calendarEvents) ? window.__calendarEvents : [];
    const evObj = events.find(x => String(x.id) === String(id));
    if(!evObj) { alert('Event not found'); return; }
    const times = Array.isArray(evObj.times) ? evObj.times : [];
    if(!times.length){ alert('This event has no triggers to save.'); return; }

    const defaultLabel = String(evObj.name || '').trim() || `Event ${id}`;
    const label = String(prompt('Trigger template label:', defaultLabel) || '').trim();
    if(!label) return;

    try{
      const r = await fetch('/api/templates/trigger', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({label, times}),
      });
      const data = await r.json().catch(() => ({}));
      if(!r.ok || !data.ok){
        throw new Error((data && data.error) ? data.error : 'Save failed');
      }
      if(confirm('Saved trigger template. Open Templates page?')){
        window.location.href = '/templates#triggers';
      }
    }catch(e){
      alert('Failed to save trigger template: ' + String(e.message || e));
    }
    return;
  }
  if(btn.classList.contains('edit-event')){
    const id = btn.getAttribute('data-id');
    // TODO: implement edit UI
    window.location.href = `/calendar/edit/${encodeURIComponent(id)}`;
    return;
  }
  if(btn.classList.contains('delete-event')){
    const id = btn.getAttribute('data-id');
    if(!id) return;
    if(!confirm('Delete event ID ' + id + '? This cannot be undone.')) return;
    try{
      const resp = await fetch(`/api/events/${encodeURIComponent(id)}`, {method: 'DELETE'});
      if(resp.ok){
        await loadEvents();
      }else{
        const txt = await resp.text();
        alert('Failed to delete event: ' + txt);
      }
    }catch(e){
      console.error(e);
      alert('Error deleting event: ' + e.message);
    }
  }
});

// initial load
loadEvents();
</script>

{% endblock %}
