{% extends 'base.html' %}

{% set page_title = 'Templates' %}

{% block content %}
<div class="mb-4">
  <h3>Button Templates</h3>
  <div id="buttons-list" class="mb-3">Loading…</div>
  <form id="add-button-form" class="row g-2">
    <div class="col-md-6"><input class="form-control" name="label" placeholder="Label"></div>
    <div class="col-md-5"><input class="form-control" name="pattern" placeholder="Pattern (e.g. 1/0/1)"></div>
    <div class="col-md-1"><button class="btn btn-sm btn-success">Add</button></div>
  </form>
</div>

<div>
  <h3>Trigger Templates</h3>
  <div id="triggers-list" class="mb-3">Loading…</div>

  <!-- Compose multiple triggers, then save as a single trigger-template -->
  <div id="add-trigger-composer" class="mb-3">
    <div id="add-trigger-triggers-container"></div>
    <form id="add-trigger-form" class="d-flex gap-2 align-items-center mt-2">
      <input name="label" class="form-control" placeholder="Template Label" style="width:200px">
      <button id="add-one-trigger" type="button" class="btn btn-sm btn-outline-secondary">Add Trigger</button>
      <button id="save-template-btn" class="btn btn-sm btn-success">Save Template</button>
    </form>
  </div>
</div>

<script>
function normalizeApiPath(p){
  let s = String(p || '').trim();
  if(!s) return '';
  if(s.includes('://')) return '';
  if(s.startsWith('/api/')) return s;
  if(s.startsWith('/')) return '/api' + s;
  return '/api/' + s.replace(/^\/+/, '');
}

function displayApiPath(p){
  const s = String(p || '').trim();
  if(s.startsWith('/api/')) return s.slice(4);
  return s;
}

async function loadTemplates(){
  try{
    const resp = await fetch('/api/templates?_ts=' + Date.now(), {cache: 'no-store'});
    const data = await resp.json();
    window.__buttonTemplates = data.buttons || [];
    renderButtons(data.buttons || []);
    renderTriggers(data.triggers || []);
  }catch(e){
    document.getElementById('buttons-list').innerText = 'Error loading';
    document.getElementById('triggers-list').innerText = 'Error loading';
    console.error(e);
  }
}

function renderButtons(btns){
  const out = document.getElementById('buttons-list');
  if(!btns.length){ out.innerHTML = '<div class="text-muted">No button templates</div>'; return }
  out.innerHTML = '';
  btns.forEach((b,i)=>{
    const div = document.createElement('div');
    div.className = 'd-flex align-items-center mb-1';

    const isEditing = (window.__editingButtonIndex === i);
    const label = b.label || '';
    const pattern = b.pattern || '';

    if(isEditing){
      div.innerHTML = `
        <div class="flex-grow-1 d-flex gap-2 align-items-center">
          <input class="form-control form-control-sm" style="max-width: 260px" data-role="button-label" value="${label.replace(/"/g,'&quot;')}">
          <input class="form-control form-control-sm" style="max-width: 160px" data-role="button-pattern" value="${pattern.replace(/"/g,'&quot;')}" placeholder="1/0/1">
          <small class="text-muted">(format: 1/0/1)</small>
        </div>
        <div class="ms-2">
          <button class="btn btn-sm btn-success" data-idx="${i}" data-type="button-save">Save</button>
          <button class="btn btn-sm btn-outline-secondary ms-2" data-idx="${i}" data-type="button-cancel">Cancel</button>
        </div>
      `;
    }else{
      // Keep URL in short format (pattern only)
      div.innerHTML = `
        <div class="flex-grow-1"><strong>${label}</strong> — <span class="text-muted">${pattern}</span></div>
        <div>
          <button class="btn btn-sm btn-outline-primary ms-2" data-idx="${i}" data-type="button-edit">Edit</button>
          <button class="btn btn-sm btn-outline-danger ms-2" data-idx="${i}" data-type="button-delete">Delete</button>
        </div>
      `;
    }
    out.appendChild(div);
  });
    // also populate buttonTemplate selects in the trigger add form
    const btSelects = document.querySelectorAll('select[name="buttonTemplate"]');
    btSelects.forEach(sel=>{
      // clear existing options except first
      const first = sel.querySelector('option[value=""]');
      sel.innerHTML = '';
      sel.appendChild(first || document.createElement('option'));
      sel.querySelector('option').value = '';
      sel.querySelector('option').text = '(none)';
      btns.forEach((b,i)=>{
        const opt = document.createElement('option'); opt.value = i; opt.text = `${b.label} — ${b.pattern}`; sel.appendChild(opt);
      });
    });
}

function renderTriggers(trigs){
  const out = document.getElementById('triggers-list');
  if(!trigs.length){ out.innerHTML = '<div class="text-muted">No trigger templates</div>'; return }
  out.innerHTML = '';
  trigs.forEach((t,i)=>{
    const div = document.createElement('div');
    div.className = 'd-flex gap-2 align-items-center mb-2';
    const times = Array.isArray(t.times) ? t.times : (t.times ? JSON.parse(t.times) : []);
    const count = times.length;
    div.innerHTML = `
      <div class="flex-grow-1"><strong>${t.label}</strong> — <small class="text-muted">${count} trigger${count!==1?'s':''}</small></div>
      <div><button class="btn btn-sm btn-outline-primary ms-2" data-idx="${i}" data-type="trigger-edit">Edit</button><button class="btn btn-sm btn-outline-danger ms-2" data-idx="${i}" data-type="trigger-delete">Delete</button></div>
    `;
    out.appendChild(div);
  });
}

function newTriggerRow(templates){
  const div = document.createElement('div');
  div.className = 'trigger-row border rounded p-2 mb-2';
  div.innerHTML = `
    <div class="d-flex gap-2 align-items-center">
      <input name="minutes" placeholder="minutes" class="form-control form-control-sm" style="width:100px">
      <select name="typeOfTrigger" class="form-select form-select-sm" style="width:140px">
        <option value="BEFORE">Before</option>
        <option value="AT">At</option>
        <option value="AFTER">After</option>
      </select>
      <select name="actionType" class="form-select form-select-sm" style="width:160px">
        <option value="companion">Companion Button</option>
        <option value="api">API Call</option>
      </select>
      <button class="btn btn-sm btn-outline-danger ms-auto remove-trigger">Remove</button>
    </div>

    <div class="mt-2 gap-2 align-items-center companion-fields" style="display:flex">
      <select name="buttonTemplate" class="form-select form-select-sm" style="min-width:220px">
        <option value="">(none)</option>
        ${templates.map((t,i)=>`<option value="${i}">${t.label} — ${t.pattern}</option>`).join('')}
      </select>
      <input name="buttonURL" placeholder="button URL (optional)" class="form-control form-control-sm">
      <small class="text-muted" style="white-space:nowrap" title="Companion short button format: bank/page/button">(bank/page/button, e.g. 1/2/3)</small>
    </div>

    <div class="mt-2 gap-2 align-items-start api-fields" style="display:none">
      <select name="apiMethod" class="form-select form-select-sm" style="width:120px">
        <option value="POST">POST</option>
        <option value="GET">GET</option>
        <option value="PUT">PUT</option>
        <option value="PATCH">PATCH</option>
        <option value="DELETE">DELETE</option>
      </select>
      <input name="apiPath" placeholder="/videohub/presets/1/apply" class="form-control form-control-sm">
      <textarea name="apiBody" placeholder='JSON body (optional)' class="form-control form-control-sm" rows="2" style="max-width:340px"></textarea>
    </div>
  `;

  // If type is AT, minutes is always 0 and should not be editable.
  const minutesInput = div.querySelector('input[name="minutes"]');
  const typeSelect = div.querySelector('select[name="typeOfTrigger"]');
  const syncMinutesDisabled = ()=>{
    if(!minutesInput || !typeSelect) return;
    const type = String(typeSelect.value || 'AT').toUpperCase();
    if(type === 'AT'){
      minutesInput.value = '0';
      minutesInput.disabled = true;
    }else{
      minutesInput.disabled = false;
    }
  };
  if(typeSelect) typeSelect.addEventListener('change', syncMinutesDisabled);
  syncMinutesDisabled();
  div.__syncMinutesDisabled = syncMinutesDisabled;

  // If a template is selected, disable custom URL input (like other pages)
  const sel = div.querySelector('select[name="buttonTemplate"]');
  const inp = div.querySelector('input[name="buttonURL"]');
  const updateDisabled = ()=>{
    if(!sel || !inp) return;
    const v = String(sel.value || '');
    if(v !== ''){
      const t = templates[parseInt(v,10)];
      inp.value = (t && t.pattern) ? String(t.pattern) : '';
      inp.disabled = true;
    }else{
      inp.disabled = false;
      // leave existing value so user can type
    }
  };
  if(sel) sel.addEventListener('change', updateDisabled);
  updateDisabled();

  // Toggle companion vs api fields
  const actionSel = div.querySelector('select[name="actionType"]');
  const companionFields = div.querySelector('.companion-fields');
  const apiFields = div.querySelector('.api-fields');
  const syncActionFields = ()=>{
    const v = String(actionSel ? actionSel.value : 'companion').toLowerCase();
    if(v === 'api'){
      if(companionFields) companionFields.style.display = 'none';
      if(apiFields) apiFields.style.display = 'flex';
      // ensure companion url isn't forced disabled by template selection
      if(inp) inp.disabled = true;
      if(sel) sel.disabled = true;
    }else{
      if(companionFields) companionFields.style.display = 'flex';
      if(apiFields) apiFields.style.display = 'none';
      if(sel) sel.disabled = false;
      if(inp) inp.disabled = false;
      updateDisabled();
    }
  };
  if(actionSel) actionSel.addEventListener('change', syncActionFields);
  syncActionFields();
  div.__syncActionFields = syncActionFields;

  return div;
}

// handle add button
document.getElementById('add-button-form').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const form = ev.target;
  const label = form.label.value.trim();
  const pattern = form.pattern.value.trim();
  if(!label || !pattern) return alert('Label and pattern required');
  // client-side validation: ensure pattern is three integers separated by '/'
  if(!/^\d+\/\d+\/\d+$/.test(pattern)){
    return alert('Pattern must be like "1/0/1" (three integers separated by "/")');
  }
  try{
    const resp = await fetch('/api/templates/button',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({label, pattern})});
    const data = await resp.json().catch(()=>null);
    if(resp.ok){ await loadTemplates(); form.reset(); }
    else {
      if(resp.status === 409 && data && data.existing){
        const ex = data.existing;
        alert(`That button is already saved as:\n\nName: ${ex.label || '(no name)'}\nButton: ${ex.pattern || ''}\nURL: ${ex.buttonURL || ''}`);
      }else{
        alert((data && data.error) ? data.error : 'Failed to add');
      }
    }
  }catch(e){ console.error(e); alert('Error adding'); }
});

// handle add trigger
// add individual trigger row to composer
document.getElementById('add-one-trigger').addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const resp = await fetch('/api/templates?_ts=' + Date.now(), {cache: 'no-store'});
  const data = await resp.json();
  const btns = data.buttons || [];
  const row = newTriggerRow(btns);
  document.getElementById('add-trigger-triggers-container').appendChild(row);
});

// remove trigger delegate
document.getElementById('add-trigger-triggers-container').addEventListener('click', (ev)=>{
  const btn = ev.target.closest('.remove-trigger');
  if(!btn) return;
  const row = btn.closest('.trigger-row');
  if(row) row.remove();
});

// submit composed trigger template (multiple triggers)
document.getElementById('add-trigger-form').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const form = ev.target;
  const label = form.label.value.trim();
  if(!label) return alert('Label required');
  const container = document.getElementById('add-trigger-triggers-container');
  const rows = Array.from(container.children);
  if(rows.length === 0) return alert('Add at least one trigger to the template');
  const specs = [];
  // fetch latest buttons to resolve template indices
  const respButtons = await fetch('/api/templates?_ts=' + Date.now(), {cache: 'no-store'});
  const dataAll = await respButtons.json();
  const btns = dataAll.buttons || [];
  for(const row of rows){
    let minsRaw = row.querySelector('input[name="minutes"]').value;
    const type = row.querySelector('select[name="typeOfTrigger"]').value || 'AT';
    const actionType = String(row.querySelector('select[name="actionType"]').value || 'companion').toLowerCase();
    const tmplSel = row.querySelector('select[name="buttonTemplate"]');
    const tmplIdx = tmplSel ? tmplSel.value : '';
    let buttonURL = (row.querySelector('input[name="buttonURL"]')?.value) || '';
    if(String(type).toUpperCase() === 'AT'){
      minsRaw = '0';
      const mi = row.querySelector('input[name="minutes"]');
      if(mi){ mi.value = '0'; mi.disabled = true; }
    }else if((minsRaw === null || minsRaw === undefined || String(minsRaw).trim() === '')){
      alert('Minutes required for non-AT triggers');
      return;
    }
    const mins = parseInt(minsRaw,10);
    if(Number.isNaN(mins) || mins < 0){ alert('Minutes must be a non-negative integer'); return; }

    if(actionType === 'api'){
      const method = String(row.querySelector('select[name="apiMethod"]').value || 'POST').toUpperCase();
      const path = String(row.querySelector('input[name="apiPath"]').value || '').trim();
      const bodyRaw = String(row.querySelector('textarea[name="apiBody"]').value || '').trim();
      const normPath = normalizeApiPath(path);
      if(!normPath || !normPath.startsWith('/api/')){ alert('API path must be like /videohub/... (the /api prefix is added automatically)'); return; }
      let body = undefined;
      if(bodyRaw){
        try{ body = JSON.parse(bodyRaw); }
        catch(e){ alert('API body must be valid JSON'); return; }
      }
      const api = {method, path: normPath};
      if(body !== undefined) api.body = body;
      specs.push({minutes: mins, typeOfTrigger: type, actionType: 'api', api});
      continue;
    }

    if(tmplIdx !== ''){
      const t = btns[parseInt(tmplIdx,10)];
      if(t) buttonURL = t.buttonURL || (t.pattern ? `location/${t.pattern}/press` : buttonURL);
    }
    if(!buttonURL || String(buttonURL).trim() === ''){ alert('Each trigger must have a button template selected or a valid button URL'); return; }
    if(/^\d+\/\d+\/\d+$/.test(buttonURL)) buttonURL = `location/${buttonURL}/press`;
    if(!/^location\/\d+\/\d+\/\d+\/press$/.test(buttonURL)){ alert('buttonURL must be like "1/2/3" or "location/1/2/3/press"'); return; }
    specs.push({minutes: mins, typeOfTrigger: type, actionType: 'companion', buttonURL});
  }
  try{
    // if editing, use PUT
    if(window.__editingTriggerIndex !== undefined && window.__editingTriggerIndex !== null){
      const idx = window.__editingTriggerIndex;
      const r = await fetch('/api/templates/trigger/'+encodeURIComponent(idx),{method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({label, times: specs})});
      if(r.ok){ await loadTemplates(); form.reset(); document.getElementById('add-trigger-triggers-container').innerHTML = ''; window.__editingTriggerIndex = null; document.getElementById('save-template-btn').innerText = 'Save Template'; }
      else { alert('Failed to update'); }
    }else{
      const r = await fetch('/api/templates/trigger',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({label, times: specs})});
      if(r.ok){ await loadTemplates(); form.reset(); document.getElementById('add-trigger-triggers-container').innerHTML = ''; }
      else { alert('Failed to add'); }
    }
  }catch(e){ console.error(e); alert('Error adding'); }
});

// delegate deletes
document.getElementById('buttons-list').addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('button');
  if(!btn) return;
  const idx = btn.getAttribute('data-idx');
  const type = btn.getAttribute('data-type');
  if(type === 'button-delete'){
    if(!confirm('Delete button template?')) return;
    try{
      const r = await fetch('/api/templates/button/'+encodeURIComponent(idx), {method:'DELETE'});
      if(r.ok) loadTemplates();
      else alert('Delete failed');
    }catch(e){alert('Error');}
  }else if(type === 'button-edit'){
    window.__editingButtonIndex = parseInt(idx, 10);
    renderButtons(window.__buttonTemplates || []);
  }else if(type === 'button-cancel'){
    window.__editingButtonIndex = null;
    renderButtons(window.__buttonTemplates || []);
  }else if(type === 'button-save'){
    const i = parseInt(idx, 10);
    const row = btn.closest('.d-flex.align-items-center.mb-1');
    const labelInput = row ? row.querySelector('[data-role="button-label"]') : null;
    const patternInput = row ? row.querySelector('[data-role="button-pattern"]') : null;
    const label = String(labelInput ? labelInput.value : '').trim();
    const pattern = String(patternInput ? patternInput.value : '').trim();
    if(!label || !pattern) return alert('Label and pattern required');
    if(!/^\d+\/\d+\/\d+$/.test(pattern)){
      return alert('Pattern must be like "1/0/1" (three integers separated by "/")');
    }
    try{
      const r = await fetch('/api/templates/button/'+encodeURIComponent(i), {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({label, pattern})
      });
      const data = await r.json().catch(()=>null);
      if(!r.ok || !data || !data.ok){
        if(r.status === 409 && data && data.existing){
          const ex = data.existing;
          alert(`That button is already saved as:\n\nName: ${ex.label || '(no name)'}\nButton: ${ex.pattern || ''}\nURL: ${ex.buttonURL || ''}`);
          return;
        }
        return alert((data && data.error) ? data.error : 'Update failed');
      }
      window.__editingButtonIndex = null;
      await loadTemplates();
    }catch(e){
      console.error(e);
      alert('Error updating');
    }
  }
});

// Save inline edit on Enter
document.getElementById('buttons-list').addEventListener('keydown', (ev)=>{
  if(ev.key !== 'Enter') return;
  const input = ev.target.closest('[data-role="button-label"], [data-role="button-pattern"]');
  if(!input) return;
  const row = input.closest('.d-flex.align-items-center.mb-1');
  const saveBtn = row ? row.querySelector('button[data-type="button-save"]') : null;
  if(saveBtn){
    ev.preventDefault();
    saveBtn.click();
  }
});

document.getElementById('triggers-list').addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('button'); if(!btn) return; const idx = btn.getAttribute('data-idx'); const type = btn.getAttribute('data-type');
  if(type === 'trigger-delete'){
    if(!confirm('Delete trigger template?')) return; try{ const r = await fetch('/api/templates/trigger/'+encodeURIComponent(idx), {method:'DELETE'}); if(r.ok) loadTemplates(); else alert('Delete failed'); }catch(e){alert('Error');}
  }else if(type === 'trigger-edit'){
    // load template and populate composer for editing
    try{
      const resp = await fetch('/api/templates?_ts=' + Date.now(), {cache: 'no-store'});
      const data = await resp.json();
      const trigs = data.triggers || [];
      const tpl = trigs[parseInt(idx,10)];
      if(!tpl) return alert('Template not found');
      // set edit index
      window.__editingTriggerIndex = parseInt(idx,10);
      const form = document.getElementById('add-trigger-form');
      form.label.value = tpl.label || '';
      document.getElementById('add-trigger-triggers-container').innerHTML = '';
      const btns = data.buttons || [];
      const times = Array.isArray(tpl.times) ? tpl.times : (tpl.times ? JSON.parse(tpl.times) : []);
      times.forEach(s=>{
        const row = newTriggerRow(btns);
        // populate
        row.querySelector('input[name="minutes"]').value = s.minutes;
        row.querySelector('select[name="typeOfTrigger"]').value = s.typeOfTrigger;
        row.querySelector('select[name="actionType"]').value = (s.actionType || 'companion');
        if(typeof row.__syncActionFields === 'function') row.__syncActionFields();
        if(typeof row.__syncMinutesDisabled === 'function') row.__syncMinutesDisabled();

        if(String(s.actionType || 'companion').toLowerCase() === 'api'){
          row.querySelector('select[name="apiMethod"]').value = (s.api && s.api.method) ? String(s.api.method).toUpperCase() : 'POST';
          row.querySelector('input[name="apiPath"]').value = (s.api && s.api.path) ? displayApiPath(String(s.api.path)) : '';
          row.querySelector('textarea[name="apiBody"]').value = (s.api && s.api.body !== undefined) ? JSON.stringify(s.api.body) : '';
        }else{
          // try to match a button template
          let matched = false;
          btns.forEach((b,bi)=>{ if(!matched){ const bu = b.buttonURL || (b.pattern?`location/${b.pattern}/press`:null); if(bu === s.buttonURL){ row.querySelector('select[name="buttonTemplate"]').value = bi; matched = true; } }});
          if(matched){
            const inp = row.querySelector('input[name="buttonURL"]');
            inp.value = (btns[parseInt(row.querySelector('select[name="buttonTemplate"]').value,10)] || {}).pattern || '';
            inp.disabled = true;
          }else{
            const inp = row.querySelector('input[name="buttonURL"]');
            inp.value = s.buttonURL;
            inp.disabled = false;
          }
        }
        document.getElementById('add-trigger-triggers-container').appendChild(row);
      });
      document.getElementById('save-template-btn').innerText = 'Update Template';
    }catch(e){ console.error(e); alert('Error loading template for edit'); }
  }
});

// initial load
loadTemplates();
</script>

{% endblock %}
