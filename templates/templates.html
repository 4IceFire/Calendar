{% extends 'base.html' %}

{% set page_title = 'Templates' %}

{% block content %}
<div class="tdeck-soft rounded-3 p-2 mb-3">
  <ul class="nav nav-pills" id="templates-tab-nav">
    <li class="nav-item">
      <button class="nav-link active" type="button" data-tab="buttons">Buttons</button>
    </li>
    <li class="nav-item ms-2">
      <button class="nav-link" type="button" data-tab="triggers">Triggers</button>
    </li>
  </ul>
</div>
<div class="row g-3">
  <div class="col-12" id="templates-tab-buttons" data-templates-tab="buttons">
    <div class="tdeck-soft rounded-3 p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div>
          <h2 class="h5 mb-0">Button Templates</h2>
          <div class="small text-muted">Reusable Companion button shortcuts.</div>
        </div>
      </div>
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="small text-muted">Folders</div>
        <div class="d-flex gap-2">
          <button id="button-folder-new" class="btn btn-sm btn-outline-primary" type="button">New Folder</button>
          <button id="button-folders-expand" class="btn btn-sm btn-outline-secondary" type="button">Expand all</button>
          <button id="button-folders-collapse" class="btn btn-sm btn-outline-secondary" type="button">Collapse all</button>
        </div>
      </div>

      <div id="buttons-tree-wrap" class="tdeck-soft rounded-3 overflow-hidden mb-3" style="background: transparent; border-color: rgba(127,127,127,0.20)">
        <div id="buttons-tree" class="list-group list-group-flush">Loading...</div>
      </div>

      <form id="add-button-form" class="row g-2 align-items-end">
        <div class="col-md-5">
          <label class="form-label small text-muted mb-1">Label</label>
          <input class="form-control" name="label" placeholder="e.g. Stream Start">
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted mb-1">Pattern</label>
          <input class="form-control" name="pattern" placeholder="1/0/1">
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted mb-1">Folder (optional)</label>
          <select id="add-button-folder" class="form-select">
            <option value="">(no folder)</option>
          </select>
        </div>
        <div class="col-md-1 d-grid">
          <button class="btn btn-sm btn-primary">Add</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-12 d-none" id="templates-tab-triggers" data-templates-tab="triggers">
    <div class="tdeck-soft rounded-3 p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div>
          <h2 class="h5 mb-0">Trigger Templates</h2>
          <div class="small text-muted">Reusable groups of triggers for events.</div>
        </div>
      </div>

      <div class="tdeck-soft rounded-3 overflow-hidden mb-3" style="display:none; background: transparent; border-color: rgba(127,127,127,0.20)">
        <div id="triggers-list" class="list-group list-group-flush">Loading...</div>
      </div>

      <div class="row g-3">
        <div class="col-md-5">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="small text-muted">Templates</div>
            <button id="trigger-template-new" class="btn btn-sm btn-outline-primary">New</button>
          </div>
          <div class="tdeck-soft rounded-3 overflow-hidden" style="background: transparent; border-color: rgba(127,127,127,0.20)">
            <div id="triggers-list-ui" class="list-group list-group-flush">Loading...</div>
          </div>
        </div>

        <div class="col-md-7">
          <div class="tdeck-soft rounded-3 p-2" style="background: transparent; border-color: rgba(127,127,127,0.20)">
            <div class="d-flex align-items-start justify-content-between gap-2 mb-2">
              <div>
                <div class="fw-semibold" id="trigger-editor-title">New Trigger Template</div>
                <div class="small text-muted" id="trigger-editor-hint">Build a reusable set of triggers, then apply it to events.</div>
              </div>
              <div class="d-flex gap-2">
                <button id="trigger-template-cancel" class="btn btn-sm btn-outline-secondary">Cancel</button>
                <button id="trigger-template-delete" class="btn btn-sm btn-outline-danger" disabled>Delete</button>
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label small text-muted mb-1">Label</label>
              <input id="trigger-template-label" class="form-control form-control-sm" placeholder="e.g. Sunday pre-service">
            </div>

            <div class="d-flex align-items-center justify-content-between mb-1">
              <div class="small text-muted">Triggers</div>
              <div class="d-flex gap-2">
                <button id="trigger-template-sort-by-time" class="btn btn-sm btn-outline-secondary" type="button" title="Sort triggers by execution time (earliest first)">Sort by time</button>
                <button id="trigger-template-add-trigger" class="btn btn-sm btn-outline-secondary">Add Trigger</button>
              </div>
            </div>

            <div id="trigger-editor-triggers-container"></div>

            <div class="d-flex justify-content-between align-items-center mt-2">
              <div class="small text-muted">Tip: use Move Up/Down to reorder.</div>
              <button id="trigger-template-save" class="btn btn-sm btn-primary">Save Template</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function normalizeApiPath(p){
  let s = String(p || '').trim();
  if(!s) return '';
  if(s.includes('://')) return '';
  if(s.startsWith('/api/')) return s;
  if(s.startsWith('/')) return '/api' + s;
  return '/api/' + s.replace(/^\/+/, '');
}

function displayApiPath(p){
  const s = String(p || '').trim();
  if(s.startsWith('/api/')) return s.slice(4);
  return s;
}

// --- Templates page tabs (Buttons / Triggers) ---
let _templatesActiveTab = 'buttons';

function _setTemplatesActiveTab(tab, {pushHash = true} = {}){
  const next = (tab === 'triggers') ? 'triggers' : 'buttons';
  _templatesActiveTab = next;

  const btns = Array.from(document.querySelectorAll('#templates-tab-nav [data-tab]'));
  for(const b of btns){
    const t = String(b.getAttribute('data-tab') || '');
    b.classList.toggle('active', t === next);
  }

  const panes = Array.from(document.querySelectorAll('[data-templates-tab]'));
  for(const p of panes){
    const t = String(p.getAttribute('data-templates-tab') || '');
    p.classList.toggle('d-none', t !== next);
  }

  try{ localStorage.setItem('templates_active_tab', next); }catch(e){}

  if(pushHash){
    try{
      const h = (next === 'triggers') ? '#triggers' : '#buttons';
      if(window.location.hash !== h) history.replaceState(null, '', h);
    }catch(e){}
  }
}

function _readInitialTemplatesTab(){
  const h = String(window.location.hash || '').toLowerCase();
  if(h === '#triggers') return 'triggers';
  if(h === '#buttons') return 'buttons';
  try{
    const saved = String(localStorage.getItem('templates_active_tab') || '');
    if(saved === 'triggers' || saved === 'buttons') return saved;
  }catch(e){}
  return 'buttons';
}

async function loadTemplates(){
  try{
    const resp = await fetch('/api/templates?_ts=' + Date.now(), {cache: 'no-store'});
    const data = await resp.json();
    window.__buttonTemplates = data.buttons || [];
    window.__buttonsTree = data.buttons_tree || {version: 2, folders: [], templates: (data.buttons || [])};
    renderButtonsTree(window.__buttonsTree);
    renderTriggerTemplates(data.triggers || []);

    if(window.__selectLastTriggerTemplate){
      window.__selectLastTriggerTemplate = false;
      const last = (Array.isArray(window.__triggerTemplates) ? window.__triggerTemplates.length : 0) - 1;
      if(last >= 0){
        _populateTriggerEditorFromTemplate(last);
      }else{
        _clearTriggerEditor();
      }
    }else{
      // If an index is selected, re-render editor title/list highlighting.
      _setTriggerEditorTitle();
    }
  }catch(e){
    document.getElementById('buttons-tree').innerText = 'Error loading';
    const tl = document.getElementById('triggers-list-ui');
    if(tl) tl.innerText = 'Error loading';
    console.error(e);
  }
}

function _btUuid(){
  try{ return crypto.randomUUID(); }catch(e){}
  return 'id_' + String(Date.now()) + '_' + String(Math.floor(Math.random()*1e9));
}

function _btTreeCoerce(tree){
  const t = (tree && typeof tree === 'object') ? tree : {version:2, folders:[], templates:[]};
  const folders = Array.isArray(t.folders) ? t.folders : [];
  const templates = Array.isArray(t.templates) ? t.templates : [];
  return {version: 2, folders, templates};
}

function _btGetFolderChildren(tree, parentId){
  return tree.folders
    .filter(f => (f && typeof f === 'object') && ((f.parentId || null) === (parentId || null)))
    .sort((a,b)=>Number(a.order||0) - Number(b.order||0));
}

function _btGetTemplateChildren(tree, folderId){
  return tree.templates
    .filter(t => (t && typeof t === 'object') && ((t.folderId || null) === (folderId || null)))
    .sort((a,b)=>Number(a.order||0) - Number(b.order||0));
}

function _btNormalizeOrders(tree){
  // folders
  const byParent = new Map();
  tree.folders.forEach(f=>{
    if(!f || typeof f !== 'object') return;
    const k = String(f.parentId || '');
    if(!byParent.has(k)) byParent.set(k, []);
    byParent.get(k).push(f);
  });
  for(const [k, arr] of byParent.entries()){
    arr.sort((a,b)=>Number(a.order||0) - Number(b.order||0));
    arr.forEach((f,i)=>{ f.order = i; });
  }

  // templates
  const byFolder = new Map();
  tree.templates.forEach(t=>{
    if(!t || typeof t !== 'object') return;
    const k = String(t.folderId || '');
    if(!byFolder.has(k)) byFolder.set(k, []);
    byFolder.get(k).push(t);
  });
  for(const [k, arr] of byFolder.entries()){
    arr.sort((a,b)=>Number(a.order||0) - Number(b.order||0));
    arr.forEach((t,i)=>{ t.order = i; });
  }
}

function _btFolderIsDescendant(tree, folderId, maybeAncestorId){
  // True if folderId is inside maybeAncestorId (at any depth).
  const parentById = new Map();
  tree.folders.forEach(f=>{
    if(!f || typeof f !== 'object') return;
    parentById.set(String(f.id || ''), String(f.parentId || ''));
  });
  let cur = String(folderId || '');
  const target = String(maybeAncestorId || '');
  const seen = new Set();
  while(cur && !seen.has(cur)){
    seen.add(cur);
    const p = parentById.get(cur) || '';
    if(!p) return false;
    if(p === target) return true;
    cur = p;
  }
  return false;
}

function _btSetFolderOpen(folderId, isOpen){
  try{ localStorage.setItem('bt_folder_open:' + String(folderId||''), isOpen ? '1' : '0'); }catch(e){}
}
function _btIsFolderOpen(folderId){
  try{
    const v = localStorage.getItem('bt_folder_open:' + String(folderId||''));
    if(v === null) return true;
    return v === '1';
  }catch(e){
    return true;
  }
}

async function _btSaveTree(){
  _btNormalizeOrders(window.__buttonsTree);
  const resp = await fetch('/api/templates/buttons_tree', {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({tree: window.__buttonsTree}),
  });
  const data = await resp.json().catch(()=>({}));
  if(!resp.ok || !data.ok) throw new Error(data.error || ('Save failed (HTTP ' + resp.status + ')'));
}

function _btPopulateFolderSelect(tree){
  const sel = document.getElementById('add-button-folder');
  if(!sel) return;
  const cur = String(sel.value || '');
  sel.innerHTML = '<option value="">(no folder)</option>';
  const walk = (parentId, depth) => {
    const kids = _btGetFolderChildren(tree, parentId);
    kids.forEach(f=>{
      const opt = document.createElement('option');
      opt.value = String(f.id || '');
      opt.textContent = `${'  '.repeat(depth)}${String(f.name || 'Folder')}`;
      sel.appendChild(opt);
      walk(String(f.id || ''), depth+1);
    });
  };
  walk(null, 0);
  // restore if still present
  Array.from(sel.options).forEach(o=>{ if(String(o.value) === cur) sel.value = cur; });
}

function renderButtonsTree(treeRaw){
  const out = document.getElementById('buttons-tree');
  if(!out) return;
  const tree = _btTreeCoerce(treeRaw);
  window.__buttonsTree = tree;

  // Ensure templates have ids (server should, but be defensive)
  tree.templates.forEach((t,i)=>{
    if(!t || typeof t !== 'object') return;
    if(!t.id) t.id = _btUuid();
    if(t.order === undefined || t.order === null) t.order = i;
  });
  tree.folders.forEach((f,i)=>{
    if(!f || typeof f !== 'object') return;
    if(!f.id) f.id = _btUuid();
    if(f.order === undefined || f.order === null) f.order = i;
  });

  _btNormalizeOrders(tree);
  _btPopulateFolderSelect(tree);

  const editingId = String(window.__editingButtonId || '');

  function renderFolder(parentId, depth){
    const frag = document.createDocumentFragment();

    const templates = _btGetTemplateChildren(tree, parentId);
    templates.forEach(t=>{
      const row = document.createElement('div');
      row.className = 'list-group-item d-flex align-items-center gap-2';
      row.setAttribute('data-type', 'template');
      row.setAttribute('data-id', String(t.id || ''));
      row.draggable = true;
      row.style.paddingLeft = (12 + depth * 18) + 'px';

      const isEditing = editingId && String(t.id || '') === editingId;
      const label = String(t.label || '');
      const pattern = String(t.pattern || '');

      if(isEditing){
        row.innerHTML = `
          <div class="flex-grow-1 d-flex flex-wrap gap-2 align-items-center">
            <input class="form-control form-control-sm" style="max-width: 260px" data-role="button-label" value="${label.replace(/"/g,'&quot;')}">
            <input class="form-control form-control-sm" style="max-width: 160px" data-role="button-pattern" value="${pattern.replace(/"/g,'&quot;')}" placeholder="1/0/1">
            <small class="text-muted">Format: 1/0/1</small>
          </div>
          <div class="ms-auto d-flex gap-2">
            <button class="btn btn-sm btn-success" data-type="button-save">Save</button>
            <button class="btn btn-sm btn-outline-secondary" data-type="button-cancel">Cancel</button>
          </div>
        `;
      }else{
        row.innerHTML = `
          <div class="flex-grow-1 text-truncate">
            <div class="fw-semibold text-truncate">${label || '(no label)'}</div>
            <div class="small text-muted text-truncate">${pattern || ''}</div>
          </div>
          <div class="ms-auto d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" data-type="button-up" title="Move up">↑</button>
            <button class="btn btn-sm btn-outline-secondary" data-type="button-down" title="Move down">↓</button>
            <button class="btn btn-sm btn-outline-secondary" data-type="button-edit">Edit</button>
            <button class="btn btn-sm btn-outline-danger" data-type="button-delete">Delete</button>
          </div>
        `;
      }
      frag.appendChild(row);
    });

    const folders = _btGetFolderChildren(tree, parentId);
    folders.forEach(f=>{
      const open = _btIsFolderOpen(f.id);
      const row = document.createElement('div');
      row.className = 'list-group-item d-flex align-items-center gap-2';
      row.setAttribute('data-type', 'folder');
      row.setAttribute('data-id', String(f.id || ''));
      row.draggable = true;
      row.style.paddingLeft = (12 + depth * 18) + 'px';
      row.innerHTML = `
        <button class="btn btn-sm btn-outline-secondary" data-type="folder-toggle" title="Expand/collapse" style="width:32px">${open ? '▾' : '▸'}</button>
        <div class="flex-grow-1 text-truncate">
          <div class="fw-semibold text-truncate">${String(f.name || 'Folder')}</div>
        </div>
        <div class="ms-auto d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary" data-type="folder-up" title="Move up">↑</button>
          <button class="btn btn-sm btn-outline-secondary" data-type="folder-down" title="Move down">↓</button>
          <button class="btn btn-sm btn-outline-secondary" data-type="folder-new-child" title="New subfolder">+</button>
          <button class="btn btn-sm btn-outline-secondary" data-type="folder-rename" title="Rename">Rename</button>
          <button class="btn btn-sm btn-outline-danger" data-type="folder-delete" title="Delete">Delete</button>
        </div>
      `;
      frag.appendChild(row);

      if(open){
        const kids = renderFolder(String(f.id || ''), depth+1);
        frag.appendChild(kids);
      }
    });

    return frag;
  }

  out.innerHTML = '';
  if(!tree.templates.length && !tree.folders.length){
    out.innerHTML = '<div class="list-group-item text-muted">No button templates</div>';
    return;
  }
  out.appendChild(renderFolder(null, 0));
}

// --- Unsaved changes guard for Trigger Templates editor ---
let _tplBaselineJson = '';
let _tplDirty = false;
let _tplDirtyDebounce = null;
let _tplPendingAction = null;
let _tplAllowUnloadOnce = false;

function _tplStableStringify(v){
  try{
    const seen = new WeakSet();
    const normalize = (x) => {
      if(x === null || x === undefined) return null;
      if(typeof x !== 'object') return x;
      if(seen.has(x)) return null;
      seen.add(x);
      if(Array.isArray(x)) return x.map(normalize);
      const out = {};
      for(const k of Object.keys(x).sort()){
        out[k] = normalize(x[k]);
      }
      return out;
    };
    return JSON.stringify(normalize(v));
  }catch(e){
    try{ return JSON.stringify(v); }catch(e2){ return ''; }
  }
}

function _tplReadEditorStateRaw(){
  const labelEl = document.getElementById('trigger-template-label');
  const container = document.getElementById('trigger-editor-triggers-container');
  if(!labelEl || !container) return null;

  const idx = (window.__selectedTriggerIndex !== undefined && window.__selectedTriggerIndex !== null)
    ? parseInt(window.__selectedTriggerIndex, 10)
    : null;

  const rows = Array.from(container.children || []);
  const times = rows.map((row) => {
    const name = row.querySelector('input[name="name"]')?.value;
    const uid = row.querySelector('input[name="uid"]')?.value;
    const minutes = row.querySelector('input[name="minutes"]')?.value;
    const typeOfTrigger = row.querySelector('select[name="typeOfTrigger"]')?.value;
    const actionType = row.querySelector('select[name="actionType"]')?.value;
    const enabled = !!(row.querySelector('input[name="enabled"]') ? row.querySelector('input[name="enabled"]').checked : true);

    const buttonTemplate = row.querySelector('select[name="buttonTemplate"]')?.value;
    const buttonURL = row.querySelector('input[name="buttonURL"]')?.value;

    const apiMethod = row.querySelector('select[name="apiMethod"]')?.value;
    const apiPath = row.querySelector('input[name="apiPath"]')?.value;
    const apiBody = row.querySelector('textarea[name="apiBody"]')?.value;

    return {
      enabled,
      name: (name === undefined) ? null : String(name),
      uid: (uid === undefined) ? null : String(uid),
      minutes: (minutes === undefined) ? null : String(minutes),
      typeOfTrigger: (typeOfTrigger === undefined) ? null : String(typeOfTrigger),
      actionType: (actionType === undefined) ? null : String(actionType),
      buttonTemplate: (buttonTemplate === undefined) ? null : String(buttonTemplate),
      buttonURL: (buttonURL === undefined) ? null : String(buttonURL),
      apiMethod: (apiMethod === undefined) ? null : String(apiMethod),
      apiPath: (apiPath === undefined) ? null : String(apiPath),
      apiBody: (apiBody === undefined) ? null : String(apiBody),
    };
  });

  return {
    selectedIndex: idx,
    label: String(labelEl.value || ''),
    times,
  };
}

function _tplComputeCurrentJson(){
  const state = _tplReadEditorStateRaw();
  if(state === null) return null;
  return _tplStableStringify(state);
}

function _tplSetBaselineFromUI(){
  const cur = _tplComputeCurrentJson();
  _tplBaselineJson = (cur === null) ? '' : cur;
  _tplDirty = false;
}

function _tplSetDirtyFlagFromUI(){
  const cur = _tplComputeCurrentJson();
  _tplDirty = (cur === null) ? true : (cur !== _tplBaselineJson);
}

function _tplScheduleDirtyRecalc(){
  if(_tplDirtyDebounce){
    clearTimeout(_tplDirtyDebounce);
    _tplDirtyDebounce = null;
  }
  _tplDirtyDebounce = setTimeout(() => {
    _tplDirtyDebounce = null;
    _tplSetDirtyFlagFromUI();
  }, 150);
}

function _tplEnsureUnsavedModal(){
  let modalEl = document.getElementById('templates-unsaved-modal');
  if(modalEl) return modalEl;

  modalEl = document.createElement('div');
  modalEl.id = 'templates-unsaved-modal';
  modalEl.className = 'modal fade';
  modalEl.tabIndex = -1;
  modalEl.setAttribute('aria-hidden', 'true');
  modalEl.innerHTML = `
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Unsaved changes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          You have unsaved changes in Trigger Templates.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-action="cancel" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-outline-danger" data-action="discard">Continue without saving</button>
          <button type="button" class="btn btn-primary" data-action="save">Save and continue</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modalEl);

  modalEl.addEventListener('click', async (e) => {
    const btn = e.target && e.target.closest ? e.target.closest('button[data-action]') : null;
    if(!btn) return;
    const action = String(btn.getAttribute('data-action') || '');
    if(action === 'discard'){
      const act = _tplPendingAction;
      _tplPendingAction = null;
      _tplAllowUnloadOnce = true;
      try{ _tplSetBaselineFromUI(); }catch(err){}
      try{
        if(window.bootstrap && window.bootstrap.Modal){
          const m = window.bootstrap.Modal.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
          m.hide();
        }
      }catch(err){}
      if(typeof act === 'function') act();
    }else if(action === 'save'){
      btn.disabled = true;
      try{
        const ok = await _triggerTemplateSaveNow({silent: false});
        if(!ok){
          _tplPendingAction = null;
          try{
            if(window.bootstrap && window.bootstrap.Modal){
              const m = window.bootstrap.Modal.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
              m.hide();
            }
          }catch(err){}
        }else{
          const act = _tplPendingAction;
          _tplPendingAction = null;
          _tplAllowUnloadOnce = true;
          try{
            if(window.bootstrap && window.bootstrap.Modal){
              const m = window.bootstrap.Modal.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
              m.hide();
            }
          }catch(err){}
          if(typeof act === 'function') act();
        }
      }catch(err){}
      btn.disabled = false;
    }
  });

  return modalEl;
}

function _tplShowUnsavedPrompt(pendingAction){
  _tplPendingAction = pendingAction;
  const modalEl = _tplEnsureUnsavedModal();
  try{
    if(window.bootstrap && window.bootstrap.Modal){
      const m = new window.bootstrap.Modal(modalEl);
      m.show();
    }else{
      const ok = window.confirm('You have unsaved changes. Leave without saving?');
      if(ok){
        const act = _tplPendingAction;
        _tplPendingAction = null;
        if(typeof act === 'function') act();
      }
    }
  }catch(e){
    const ok = window.confirm('You have unsaved changes. Leave without saving?');
    if(ok){
      const act = _tplPendingAction;
      _tplPendingAction = null;
      if(typeof act === 'function') act();
    }
  }
}

function _tplGuardOrRun(action){
  try{
    _tplSetDirtyFlagFromUI();
  }catch(e){
    _tplDirty = true;
  }
  if(!_tplDirty){
    if(typeof action === 'function') action();
    return true;
  }
  _tplShowUnsavedPrompt(action);
  return false;
}

function _safeParseTimes(v){
  if(Array.isArray(v)) return v;
  if(!v) return [];
  try{
    const parsed = JSON.parse(v);
    return Array.isArray(parsed) ? parsed : [];
  }catch(e){
    return [];
  }
}

function renderTriggerTemplates(trigs){
  window.__triggerTemplates = Array.isArray(trigs) ? trigs : [];
  const out = document.getElementById('triggers-list-ui');
  if(!out) return;
  if(!window.__triggerTemplates.length){
    out.innerHTML = '<div class="list-group-item text-muted">No trigger templates</div>';
    return;
  }

  const selected = (window.__selectedTriggerIndex !== undefined) ? window.__selectedTriggerIndex : null;

  out.innerHTML = '';
  window.__triggerTemplates.forEach((t,i)=>{
    const div = document.createElement('div');
    const times = _safeParseTimes(t.times);
    const count = times.length;
    const enabledCount = times.filter(x => x && x.enabled !== false).length;
    const isSelected = (selected !== null && selected !== undefined && parseInt(selected,10) === i);

    div.className = 'list-group-item d-flex gap-2 align-items-center' + (isSelected ? ' active' : '');
    div.setAttribute('data-idx', String(i));

    div.innerHTML = `
      <div class="flex-grow-1 text-truncate">
        <div class="fw-semibold text-truncate">${String(t.label || 'Template')}</div>
        <div class="small ${isSelected ? 'text-light' : 'text-muted'}">${enabledCount}/${count} enabled</div>
      </div>
      <div class="ms-auto">
        <button class="btn btn-sm ${isSelected ? 'btn-light' : 'btn-outline-danger'}" data-idx="${i}" data-type="trigger-delete">Delete</button>
      </div>
    `;

    out.appendChild(div);
  });
}

function newTriggerRow(templates){
  const uid = _btUuid(); // stable per trigger row (may be overwritten when loading existing specs)
  const div = document.createElement('div');
  div.className = 'trigger-row border rounded p-2 mb-2';
  div.setAttribute('data-uid', uid);
  div.innerHTML = `
    <div class="d-flex gap-2 align-items-center">
      <button type="button" class="btn btn-sm btn-outline-secondary toggle-collapse" title="Collapse/expand" style="width:32px">▾</button>
      <input name="name" placeholder="Trigger name (optional)" class="form-control form-control-sm" style="max-width: 360px">
      <div class="ms-auto small text-muted" data-role="trigger-summary" style="white-space:nowrap"></div>
    </div>

    <input type="hidden" name="uid" value="${uid}">

    <div class="trigger-body mt-2">
      <div class="d-flex gap-2 align-items-center">
        <input name="minutes" placeholder="minutes" class="form-control form-control-sm" style="width:100px">
        <select name="typeOfTrigger" class="form-select form-select-sm" style="width:140px">
          <option value="BEFORE">Before</option>
          <option value="AT">At</option>
          <option value="AFTER">After</option>
        </select>
        <select name="actionType" class="form-select form-select-sm" style="width:160px">
          <option value="companion">Companion Button</option>
          <option value="api">API Call</option>
        </select>
        <div class="ms-auto d-flex align-items-center gap-2">
          <button type="button" class="btn btn-sm btn-outline-secondary move-up" title="Move up">↑</button>
          <button type="button" class="btn btn-sm btn-outline-secondary move-down" title="Move down">↓</button>
          <div class="form-check form-switch mb-0" title="Enable/disable this trigger">
            <input class="form-check-input" type="checkbox" name="enabled" checked>
          </div>
          <button class="btn btn-sm btn-outline-danger remove-trigger">Remove</button>
        </div>
      </div>

        <div class="mt-2 gap-2 align-items-center companion-fields" style="display:flex">
         <select name="buttonTemplate" class="form-select form-select-sm" style="min-width:220px">
            <option value="">(none)</option>
            ${templates.map((t,i)=>{
              const label = String((t && t.label) ? t.label : '').trim();
              const fallback = String((t && t.pattern) ? t.pattern : '').trim();
              const display = label || fallback || '(no label)';
              return `<option value="${i}">${display}</option>`;
            }).join('')}
          </select>
          <input name="buttonURL" placeholder="button URL (optional)" class="form-control form-control-sm">
        <small class="text-muted" style="white-space:nowrap" title="Companion short button format: bank/page/button">(bank/page/button, e.g. 1/2/3)</small>
      </div>

      <div class="mt-2 gap-2 align-items-start api-fields" style="display:none">
        <select name="apiMethod" class="form-select form-select-sm" style="width:120px">
          <option value="POST">POST</option>
          <option value="GET">GET</option>
          <option value="PUT">PUT</option>
          <option value="PATCH">PATCH</option>
          <option value="DELETE">DELETE</option>
        </select>
        <input name="apiPath" placeholder="/videohub/presets/1/apply" class="form-control form-control-sm">
        <textarea name="apiBody" placeholder='JSON body (optional)' class="form-control form-control-sm" rows="2" style="max-width:340px"></textarea>
      </div>
    </div>
  `;

  // If type is AT, minutes is always 0 and should not be editable.
  const minutesInput = div.querySelector('input[name="minutes"]');
  const typeSelect = div.querySelector('select[name="typeOfTrigger"]');
  const syncMinutesDisabled = ()=>{
    if(!minutesInput || !typeSelect) return;
    const type = String(typeSelect.value || 'AT').toUpperCase();
    if(type === 'AT'){
      minutesInput.value = '0';
      minutesInput.disabled = true;
    }else{
      minutesInput.disabled = false;
    }
  };
  if(typeSelect) typeSelect.addEventListener('change', syncMinutesDisabled);
  syncMinutesDisabled();
  div.__syncMinutesDisabled = syncMinutesDisabled;

  const summaryEl = div.querySelector('[data-role="trigger-summary"]');
  const syncSummary = ()=>{
    if(!summaryEl || !typeSelect || !minutesInput) return;
    const typ = String(typeSelect.value || 'AT').toUpperCase();
    const mins = parseInt(String(minutesInput.value || '0'), 10);
    if(typ === 'AT'){
      summaryEl.textContent = 'At (0m)';
      return;
    }
    const m = Number.isFinite(mins) ? mins : 0;
    summaryEl.textContent = (typ === 'BEFORE') ? `Before ${m}m` : `After ${m}m`;
  };
  if(typeSelect) typeSelect.addEventListener('change', syncSummary);
  if(minutesInput) minutesInput.addEventListener('input', syncSummary);
  syncSummary();
  div.__syncSummary = syncSummary;

  // If a template is selected, disable custom URL input (like other pages)
  const sel = div.querySelector('select[name="buttonTemplate"]');
  const inp = div.querySelector('input[name="buttonURL"]');
  const updateDisabled = ()=>{
    if(!sel || !inp) return;
    const v = String(sel.value || '');
    if(v !== ''){
      const t = templates[parseInt(v,10)];
      inp.value = (t && t.pattern) ? String(t.pattern) : '';
      inp.disabled = true;
    }else{
      inp.disabled = false;
      // leave existing value so user can type
    }
  };
  if(sel) sel.addEventListener('change', updateDisabled);
  updateDisabled();

  // Toggle companion vs api fields
  const actionSel = div.querySelector('select[name="actionType"]');
  const companionFields = div.querySelector('.companion-fields');
  const apiFields = div.querySelector('.api-fields');
  const syncActionFields = ()=>{
    const v = String(actionSel ? actionSel.value : 'companion').toLowerCase();
    if(v === 'api'){
      if(companionFields) companionFields.style.display = 'none';
      if(apiFields) apiFields.style.display = 'flex';
      // ensure companion url isn't forced disabled by template selection
      if(inp) inp.disabled = true;
      if(sel) sel.disabled = true;
    }else{
      if(companionFields) companionFields.style.display = 'flex';
      if(apiFields) apiFields.style.display = 'none';
      if(sel) sel.disabled = false;
      if(inp) inp.disabled = false;
      updateDisabled();
    }
  };
  if(actionSel) actionSel.addEventListener('change', syncActionFields);
  syncActionFields();
  div.__syncActionFields = syncActionFields;

  // Apply persisted collapse state (per template id + trigger uid)
  const applyCollapsed = ()=>{
    const tplIdx = (window.__selectedTriggerIndex !== undefined && window.__selectedTriggerIndex !== null) ? parseInt(window.__selectedTriggerIndex, 10) : null;
    const tpl = (tplIdx !== null && Array.isArray(window.__triggerTemplates)) ? window.__triggerTemplates[tplIdx] : null;
    const tplId = tpl && tpl.id ? String(tpl.id) : 'new';
    const uidEl = div.querySelector('input[name="uid"]');
    const uidVal = uidEl ? String(uidEl.value || '').trim() : String(div.getAttribute('data-uid') || '').trim();
    const key = `tplTrigCollapsed:${tplId}:${uidVal}`;
    let collapsed = false;
    try{ collapsed = localStorage.getItem(key) === '1'; }catch(e){}
    const body = div.querySelector('.trigger-body');
    const btn = div.querySelector('.toggle-collapse');
    if(body) body.style.display = collapsed ? 'none' : '';
    if(btn) btn.textContent = collapsed ? '▸' : '▾';
  };
  applyCollapsed();
  div.__applyCollapsed = applyCollapsed;

  return div;
}

// handle add button
document.getElementById('add-button-form').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const form = ev.target;
  const label = form.label.value.trim();
  const pattern = form.pattern.value.trim();
  const folderSel = document.getElementById('add-button-folder');
  const folderId = folderSel ? String(folderSel.value || '').trim() : '';
  if(!label || !pattern) return alert('Label and pattern required');
  // client-side validation: ensure pattern is three integers separated by '/'
  if(!/^\d+\/\d+\/\d+$/.test(pattern)){
    return alert('Pattern must be like "1/0/1" (three integers separated by "/")');
  }
  try{
    const resp = await fetch('/api/templates/button',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({label, pattern, folderId: folderId || null})});
    const data = await resp.json().catch(()=>null);
    if(resp.ok){ await loadTemplates(); form.reset(); }
    else {
      if(resp.status === 409 && data && data.existing){
        const ex = data.existing;
        alert(`That button is already saved as:\n\nName: ${ex.label || '(no name)'}\nButton: ${ex.pattern || ''}\nURL: ${ex.buttonURL || ''}`);
      }else{
        alert((data && data.error) ? data.error : 'Failed to add');
      }
    }
  }catch(e){ console.error(e); alert('Error adding'); }
});

function _setTriggerEditorTitle(){
  const titleEl = document.getElementById('trigger-editor-title');
  const deleteBtn = document.getElementById('trigger-template-delete');
  const idx = (window.__selectedTriggerIndex !== undefined) ? window.__selectedTriggerIndex : null;
  const isEditing = (idx !== null && idx !== undefined);
  if(deleteBtn) deleteBtn.disabled = !isEditing;

  if(!titleEl) return;
  if(!isEditing){
    titleEl.textContent = 'New Trigger Template';
    return;
  }
  const t = (Array.isArray(window.__triggerTemplates) ? window.__triggerTemplates : [])[parseInt(idx,10)];
  const label = t ? String(t.label || 'Template') : 'Template';
  titleEl.textContent = `Edit: ${label}`;
}

function _clearTriggerEditor(){
  window.__selectedTriggerIndex = null;
  const labelEl = document.getElementById('trigger-template-label');
  const container = document.getElementById('trigger-editor-triggers-container');
  if(labelEl) labelEl.value = '';
  if(container) container.innerHTML = '';
  _setTriggerEditorTitle();
  renderTriggerTemplates(window.__triggerTemplates || []);
  _tplSetBaselineFromUI();
}

function _populateTriggerEditorFromTemplate(idx){
  const i = parseInt(idx,10);
  const trigs = Array.isArray(window.__triggerTemplates) ? window.__triggerTemplates : [];
  const t = trigs[i];
  if(!t) return;

  window.__selectedTriggerIndex = i;

  const labelEl = document.getElementById('trigger-template-label');
  const container = document.getElementById('trigger-editor-triggers-container');
  if(labelEl) labelEl.value = String(t.label || '');
  if(container) container.innerHTML = '';

  const btns = Array.isArray(window.__buttonTemplates) ? window.__buttonTemplates : [];
  const times = _safeParseTimes(t.times);
  for(const s of times){
    const row = newTriggerRow(btns);
    row.querySelector('input[name="name"]').value = String((s && s.name) ? s.name : '');
    if(s && s.uid){
      const uidEl = row.querySelector('input[name="uid"]');
      if(uidEl) uidEl.value = String(s.uid);
      row.setAttribute('data-uid', String(s.uid));
    }
    row.querySelector('input[name="minutes"]').value = s.minutes;
    row.querySelector('select[name="typeOfTrigger"]').value = s.typeOfTrigger;
    row.querySelector('select[name="actionType"]').value = (s.actionType || 'companion');
    const en = (s && s.enabled !== false);
    const enInput = row.querySelector('input[name="enabled"]');
    if(enInput) enInput.checked = !!en;
    if(typeof row.__syncActionFields === 'function') row.__syncActionFields();
    if(typeof row.__syncMinutesDisabled === 'function') row.__syncMinutesDisabled();
    if(typeof row.__syncSummary === 'function') row.__syncSummary();
    if(typeof row.__applyCollapsed === 'function') row.__applyCollapsed();

    if(String(s.actionType || 'companion').toLowerCase() === 'api'){
      row.querySelector('select[name="apiMethod"]').value = (s.api && s.api.method) ? String(s.api.method).toUpperCase() : 'POST';
      row.querySelector('input[name="apiPath"]').value = (s.api && s.api.path) ? displayApiPath(String(s.api.path)) : '';
      row.querySelector('textarea[name="apiBody"]').value = (s.api && s.api.body !== undefined) ? JSON.stringify(s.api.body) : '';
    }else{
      // try to match a button template
      let matched = false;
      btns.forEach((b,bi)=>{
        if(matched) return;
        const bu = b.buttonURL || (b.pattern ? `location/${b.pattern}/press` : null);
        if(bu === s.buttonURL){
          row.querySelector('select[name="buttonTemplate"]').value = bi;
          matched = true;
        }
      });
      const inp = row.querySelector('input[name="buttonURL"]');
      if(matched){
        inp.value = (btns[parseInt(row.querySelector('select[name="buttonTemplate"]').value,10)] || {}).pattern || '';
        inp.disabled = true;
      }else{
        inp.value = s.buttonURL || '';
        inp.disabled = false;
      }
    }

    if(container) container.appendChild(row);
  }

  _setTriggerEditorTitle();
  renderTriggerTemplates(window.__triggerTemplates || []);
  _tplSetBaselineFromUI();
}

function _collectTriggerSpecsFromEditor(){
  const labelEl = document.getElementById('trigger-template-label');
  const label = String(labelEl ? labelEl.value : '').trim();
  if(!label) return {ok:false, error:'Label required'};

  const container = document.getElementById('trigger-editor-triggers-container');
  const rows = container ? Array.from(container.children) : [];
  if(!rows.length) return {ok:false, error:'Add at least one trigger'};

  const btns = Array.isArray(window.__buttonTemplates) ? window.__buttonTemplates : [];
  const specs = [];

  for(const row of rows){
    const name = String(row.querySelector('input[name="name"]')?.value || '').trim();
    const uid = String(row.querySelector('input[name="uid"]')?.value || '').trim();
    let minsRaw = row.querySelector('input[name="minutes"]').value;
    const type = row.querySelector('select[name="typeOfTrigger"]').value || 'AT';
    const actionType = String(row.querySelector('select[name="actionType"]').value || 'companion').toLowerCase();
    const enabledInput = row.querySelector('input[name="enabled"]');
    const enabled = !!(enabledInput ? enabledInput.checked : true);

    if(String(type).toUpperCase() === 'AT'){
      minsRaw = '0';
      const mi = row.querySelector('input[name="minutes"]');
      if(mi){ mi.value = '0'; mi.disabled = true; }
    }else if((minsRaw === null || minsRaw === undefined || String(minsRaw).trim() === '')){
      return {ok:false, error:'Minutes required for non-AT triggers'};
    }

    const mins = parseInt(minsRaw,10);
    if(Number.isNaN(mins) || mins < 0) return {ok:false, error:'Minutes must be a non-negative integer'};

    if(actionType === 'api'){
      const method = String(row.querySelector('select[name="apiMethod"]').value || 'POST').toUpperCase();
      const path = String(row.querySelector('input[name="apiPath"]').value || '').trim();
      const bodyRaw = String(row.querySelector('textarea[name="apiBody"]').value || '').trim();
      const normPath = normalizeApiPath(path);
      if(!normPath || !normPath.startsWith('/api/')) return {ok:false, error:'API path must be like /videohub/... (the /api prefix is added automatically)'};
      let body = undefined;
      if(bodyRaw){
        try{ body = JSON.parse(bodyRaw); }
        catch(e){ return {ok:false, error:'API body must be valid JSON'}; }
      }
      const api = {method, path: normPath};
      if(body !== undefined) api.body = body;
      specs.push({uid, name, minutes: mins, typeOfTrigger: type, enabled, actionType: 'api', api});
      continue;
    }

    const tmplSel = row.querySelector('select[name="buttonTemplate"]');
    const tmplIdx = tmplSel ? String(tmplSel.value || '') : '';
    let buttonURL = (row.querySelector('input[name="buttonURL"]')?.value) || '';

    if(tmplIdx !== ''){
      const t = btns[parseInt(tmplIdx,10)];
      if(t) buttonURL = t.buttonURL || (t.pattern ? `location/${t.pattern}/press` : buttonURL);
    }

    if(!buttonURL || String(buttonURL).trim() === '') return {ok:false, error:'Each trigger must have a button template selected or a valid button URL'};
    if(/^\d+\/\d+\/\d+$/.test(buttonURL)) buttonURL = `location/${buttonURL}/press`;
    if(!/^location\/\d+\/\d+\/\d+\/press$/.test(buttonURL)) return {ok:false, error:'buttonURL must be like \"1/2/3\" or \"location/1/2/3/press\"'};

    specs.push({uid, name, minutes: mins, typeOfTrigger: type, enabled, actionType: 'companion', buttonURL});
  }

  return {ok:true, label, times: specs};
}

async function _triggerTemplateSaveNow({silent = false} = {}){
  const collected = _collectTriggerSpecsFromEditor();
  if(!collected.ok){
    if(!silent) alert(collected.error || 'Invalid template');
    return false;
  }

  const idx = (window.__selectedTriggerIndex !== undefined) ? window.__selectedTriggerIndex : null;
  try{
    if(idx === null || idx === undefined){
      const r = await fetch('/api/templates/trigger', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({label: collected.label, times: collected.times}),
      });
      if(!r.ok){
        if(!silent) alert('Failed to save');
        return false;
      }
      window.__selectLastTriggerTemplate = true;
      await loadTemplates();
      return true;
    }

    const r = await fetch('/api/templates/trigger/' + encodeURIComponent(idx), {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({label: collected.label, times: collected.times}),
    });
    if(!r.ok){
      if(!silent) alert('Failed to update');
      return false;
    }
    await loadTemplates();
    _populateTriggerEditorFromTemplate(idx);
    return true;
  }catch(e){
    console.error(e);
    if(!silent) alert('Error saving');
    return false;
  }
}

document.getElementById('trigger-template-new').addEventListener('click', (ev)=>{
  ev.preventDefault();
  _tplGuardOrRun(() => _clearTriggerEditor());
});

document.getElementById('trigger-template-add-trigger').addEventListener('click', (ev)=>{
  ev.preventDefault();
  const container = document.getElementById('trigger-editor-triggers-container');
  if(!container) return;
  const btns = Array.isArray(window.__buttonTemplates) ? window.__buttonTemplates : [];
  container.appendChild(newTriggerRow(btns));
});

function _tplOffsetMinutesFromRow(row){
  try{
    const type = String(row.querySelector('select[name="typeOfTrigger"]')?.value || 'AT').toUpperCase();
    const mins = parseInt(String(row.querySelector('input[name="minutes"]')?.value || '0'), 10);
    const m = Number.isFinite(mins) ? mins : 0;
    if(type === 'BEFORE') return -m;
    if(type === 'AFTER') return +m;
    return 0;
  }catch(e){
    return 0;
  }
}

function _sortTriggerTemplateEditorByTime(){
  const container = document.getElementById('trigger-editor-triggers-container');
  if(!container) return;
  const rows = Array.from(container.children || []).filter(x => x && x.classList && x.classList.contains('trigger-row'));
  if(rows.length < 2) return;

  rows.forEach(r=>{
    try{ if(typeof r.__syncMinutesDisabled === 'function') r.__syncMinutesDisabled(); }catch(e){}
    try{ if(typeof r.__syncSummary === 'function') r.__syncSummary(); }catch(e){}
  });

  const decorated = rows.map((r, i) => ({r, i, off: _tplOffsetMinutesFromRow(r)}));
  decorated.sort((a,b) => (a.off - b.off) || (a.i - b.i));
  for(const d of decorated){
    container.appendChild(d.r);
  }
}

const sortTplBtn = document.getElementById('trigger-template-sort-by-time');
if(sortTplBtn){
  sortTplBtn.addEventListener('click', (ev)=>{
    ev.preventDefault();
    _sortTriggerTemplateEditorByTime();
  });
}

document.getElementById('trigger-template-cancel').addEventListener('click', (ev)=>{
  ev.preventDefault();
  const idx = (window.__selectedTriggerIndex !== undefined) ? window.__selectedTriggerIndex : null;
  const act = () => {
    if(idx === null || idx === undefined){
      _clearTriggerEditor();
    }else{
      _populateTriggerEditorFromTemplate(idx);
    }
  };
  _tplGuardOrRun(act);
});

document.getElementById('trigger-template-delete').addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const idx = (window.__selectedTriggerIndex !== undefined) ? window.__selectedTriggerIndex : null;
  if(idx === null || idx === undefined) return;

  // Deleting discards the current editor state; confirm if dirty.
  try{ _tplSetDirtyFlagFromUI(); }catch(e){ _tplDirty = true; }
  if(_tplDirty){
    const ok = confirm('You have unsaved changes. Delete this template anyway?');
    if(!ok) return;
  }

  if(!confirm('Delete trigger template?')) return;
  try{
    const r = await fetch('/api/templates/trigger/' + encodeURIComponent(idx), {method:'DELETE'});
    if(!r.ok) return alert('Delete failed');
    window.__selectedTriggerIndex = null;
    await loadTemplates();
    _clearTriggerEditor();
  }catch(e){
    console.error(e);
    alert('Error deleting');
  }
});

document.getElementById('trigger-template-save').addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const ok = await _triggerTemplateSaveNow();
  if(ok){
    _tplSetBaselineFromUI();
  }
});

let _btDrag = null;
const _btTreeEl = document.getElementById('buttons-tree');

function _btFindTemplateById(tplId){
  const tree = window.__buttonsTree;
  if(!tree || !Array.isArray(tree.templates)) return null;
  return tree.templates.find(t => t && String(t.id || '') === String(tplId || '')) || null;
}
function _btFindFolderById(folderId){
  const tree = window.__buttonsTree;
  if(!tree || !Array.isArray(tree.folders)) return null;
  return tree.folders.find(f => f && String(f.id || '') === String(folderId || '')) || null;
}

async function _btMoveTemplateToFolder(tplId, folderId){
  const tree = window.__buttonsTree;
  const t = _btFindTemplateById(tplId);
  if(!tree || !t) return;
  const targetFolderId = folderId ? String(folderId) : null;
  t.folderId = targetFolderId;
  try{
    const siblings = tree.templates.filter(x => x && (x.folderId || null) === targetFolderId);
    const maxOrder = Math.max(-1, ...siblings.map(x => Number(x.order || 0)));
    t.order = maxOrder + 1;
  }catch(e){}
  await _btSaveTree();
  renderButtonsTree(tree);
}

async function _btMoveFolderToFolder(folderId, parentFolderId){
  const tree = window.__buttonsTree;
  const f = _btFindFolderById(folderId);
  if(!tree || !f) return;
  const target = parentFolderId ? String(parentFolderId) : null;
  if(target && String(f.id || '') === target) return;
  if(target && _btFolderIsDescendant(tree, target, String(f.id || ''))) return;
  f.parentId = target;
  try{
    const siblings = tree.folders.filter(x => x && (x.parentId || null) === target);
    const maxOrder = Math.max(-1, ...siblings.map(x => Number(x.order || 0)));
    f.order = maxOrder + 1;
  }catch(e){}
  await _btSaveTree();
  renderButtonsTree(tree);
}

async function _btDeleteFolder(folderId){
  const tree = window.__buttonsTree;
  if(!tree) return;
  const f = _btFindFolderById(folderId);
  if(!f) return;
  const parentId = f.parentId ? String(f.parentId) : null;

  tree.templates.forEach(t=>{
    if(!t || typeof t !== 'object') return;
    if((t.folderId || null) === String(f.id || '')) t.folderId = parentId;
  });
  tree.folders.forEach(ch=>{
    if(!ch || typeof ch !== 'object') return;
    if((ch.parentId || null) === String(f.id || '')) ch.parentId = parentId;
  });
  tree.folders = tree.folders.filter(x => x && String(x.id || '') !== String(f.id || ''));
  await _btSaveTree();
  renderButtonsTree(tree);
}

async function _btMoveUp(kind, id){
  const tree = window.__buttonsTree;
  if(!tree) return;
  if(kind === 'template'){
    const t = _btFindTemplateById(id);
    if(!t) return;
    const fid = t.folderId || null;
    const siblings = tree.templates.filter(x => x && (x.folderId || null) === fid).sort((a,b)=>Number(a.order||0)-Number(b.order||0));
    const idx = siblings.findIndex(x => String(x.id||'') === String(id||''));
    if(idx <= 0) return;
    const a = siblings[idx-1], b = siblings[idx];
    const tmp = a.order; a.order = b.order; b.order = tmp;
  }else if(kind === 'folder'){
    const f = _btFindFolderById(id);
    if(!f) return;
    const pid = f.parentId || null;
    const siblings = tree.folders.filter(x => x && (x.parentId || null) === pid).sort((a,b)=>Number(a.order||0)-Number(b.order||0));
    const idx = siblings.findIndex(x => String(x.id||'') === String(id||''));
    if(idx <= 0) return;
    const a = siblings[idx-1], b = siblings[idx];
    const tmp = a.order; a.order = b.order; b.order = tmp;
  }
  await _btSaveTree();
  renderButtonsTree(tree);
}

async function _btMoveDown(kind, id){
  const tree = window.__buttonsTree;
  if(!tree) return;
  if(kind === 'template'){
    const t = _btFindTemplateById(id);
    if(!t) return;
    const fid = t.folderId || null;
    const siblings = tree.templates.filter(x => x && (x.folderId || null) === fid).sort((a,b)=>Number(a.order||0)-Number(b.order||0));
    const idx = siblings.findIndex(x => String(x.id||'') === String(id||''));
    if(idx < 0 || idx >= siblings.length-1) return;
    const a = siblings[idx], b = siblings[idx+1];
    const tmp = a.order; a.order = b.order; b.order = tmp;
  }else if(kind === 'folder'){
    const f = _btFindFolderById(id);
    if(!f) return;
    const pid = f.parentId || null;
    const siblings = tree.folders.filter(x => x && (x.parentId || null) === pid).sort((a,b)=>Number(a.order||0)-Number(b.order||0));
    const idx = siblings.findIndex(x => String(x.id||'') === String(id||''));
    if(idx < 0 || idx >= siblings.length-1) return;
    const a = siblings[idx], b = siblings[idx+1];
    const tmp = a.order; a.order = b.order; b.order = tmp;
  }
  await _btSaveTree();
  renderButtonsTree(tree);
}

if(_btTreeEl){
  _btTreeEl.addEventListener('dragstart', (ev)=>{
    const row = ev.target.closest('.list-group-item[data-type][data-id]');
    if(!row) return;
    const type = row.getAttribute('data-type');
    const id = row.getAttribute('data-id');
    if(!type || !id) return;
    _btDrag = {type, id};
    try{ ev.dataTransfer.setData('text/plain', type + ':' + id); }catch(e){}
  });
  _btTreeEl.addEventListener('dragover', (ev)=>{
    if(!_btDrag) return;
    ev.preventDefault();
  });
  _btTreeEl.addEventListener('drop', async (ev)=>{
    if(!_btDrag) return;
    ev.preventDefault();
    const targetFolderRow = ev.target.closest('.list-group-item[data-type=\"folder\"][data-id]');
    const targetFolderId = targetFolderRow ? String(targetFolderRow.getAttribute('data-id') || '') : null;
    const dragged = _btDrag;
    _btDrag = null;
    try{
      if(dragged.type === 'template'){
        await _btMoveTemplateToFolder(dragged.id, targetFolderId);
      }else if(dragged.type === 'folder'){
        await _btMoveFolderToFolder(dragged.id, targetFolderId);
      }
    }catch(e){
      console.error(e);
      alert('Move failed');
    }
  });

  _btTreeEl.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button[data-type]');
    const row = ev.target.closest('.list-group-item[data-type][data-id]');
    const rowType = row ? row.getAttribute('data-type') : null;
    const rowId = row ? row.getAttribute('data-id') : null;

    if(btn && rowType === 'folder' && rowId){
      const action = btn.getAttribute('data-type');
      if(action === 'folder-toggle'){
        const open = !_btIsFolderOpen(rowId);
        _btSetFolderOpen(rowId, open);
        renderButtonsTree(window.__buttonsTree);
        return;
      }
      if(action === 'folder-new-child'){
        const name = prompt('Folder name?');
        if(!name) return;
        const tree = window.__buttonsTree;
        tree.folders = Array.isArray(tree.folders) ? tree.folders : [];
        const kids = tree.folders.filter(x => x && (x.parentId || null) === String(rowId));
        const maxOrder = Math.max(-1, ...kids.map(x => Number(x.order || 0)));
        tree.folders.push({id: _btUuid(), name: String(name).trim(), parentId: String(rowId), order: maxOrder+1});
        await _btSaveTree();
        _btSetFolderOpen(rowId, true);
        renderButtonsTree(tree);
        return;
      }
      if(action === 'folder-rename'){
        const f = _btFindFolderById(rowId);
        const name = prompt('Rename folder:', f ? String(f.name || '') : '');
        if(name === null) return;
        if(f) f.name = String(name).trim() || 'Folder';
        await _btSaveTree();
        renderButtonsTree(window.__buttonsTree);
        return;
      }
      if(action === 'folder-delete'){
        if(!confirm('Delete folder? Items inside will be moved to the parent.')) return;
        await _btDeleteFolder(rowId);
        return;
      }
      if(action === 'folder-up'){ await _btMoveUp('folder', rowId); return; }
      if(action === 'folder-down'){ await _btMoveDown('folder', rowId); return; }
    }

    if(btn && rowType === 'template' && rowId){
      const action = btn.getAttribute('data-type');
      if(action === 'button-up'){ await _btMoveUp('template', rowId); return; }
      if(action === 'button-down'){ await _btMoveDown('template', rowId); return; }
      if(action === 'button-delete'){
        if(!confirm('Delete button template?')) return;
        try{
          const r = await fetch('/api/templates/button/' + encodeURIComponent(rowId), {method:'DELETE'});
          const data = await r.json().catch(()=>({}));
          if(!r.ok || !data.ok) return alert(data.error || 'Delete failed');
          await loadTemplates();
        }catch(e){ console.error(e); alert('Error'); }
        return;
      }
      if(action === 'button-edit'){
        window.__editingButtonId = String(rowId);
        renderButtonsTree(window.__buttonsTree);
        return;
      }
      if(action === 'button-cancel'){
        window.__editingButtonId = null;
        renderButtonsTree(window.__buttonsTree);
        return;
      }
      if(action === 'button-save'){
        const rowEl = btn.closest('.list-group-item');
        const labelInput = rowEl ? rowEl.querySelector('[data-role=\"button-label\"]') : null;
        const patternInput = rowEl ? rowEl.querySelector('[data-role=\"button-pattern\"]') : null;
        const label = String(labelInput ? labelInput.value : '').trim();
        const pattern = String(patternInput ? patternInput.value : '').trim();
        if(!label || !pattern) return alert('Label and pattern required');
          if(!/^\d+\/\d+\/\d+$/.test(pattern)) return alert('Pattern must be like "1/0/1" (three integers separated by "/")');
        try{
          const r = await fetch('/api/templates/button/' + encodeURIComponent(rowId), {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({label, pattern})
          });
          const data = await r.json().catch(()=>({}));
          if(!r.ok || !data.ok){
            if(r.status === 409 && data && data.existing){
              const ex = data.existing;
              alert(`That button is already saved as:\\n\\nName: ${ex.label || '(no name)'}\\nButton: ${ex.pattern || ''}\\nURL: ${ex.buttonURL || ''}`);
              return;
            }
            return alert(data.error || 'Update failed');
          }
          window.__editingButtonId = null;
          await loadTemplates();
        }catch(e){
          console.error(e);
          alert('Error updating');
        }
        return;
      }
    }
  });

  _btTreeEl.addEventListener('keydown', (ev)=>{
    if(ev.key !== 'Enter') return;
    const input = ev.target.closest('[data-role=\"button-label\"], [data-role=\"button-pattern\"]');
    if(!input) return;
    const row = input.closest('.list-group-item');
    const saveBtn = row ? row.querySelector('button[data-type=\"button-save\"]') : null;
    if(saveBtn){
      ev.preventDefault();
      saveBtn.click();
    }
  });
}

const _newFolderBtn = document.getElementById('button-folder-new');
if(_newFolderBtn){
  _newFolderBtn.addEventListener('click', async (ev)=>{
    ev.preventDefault();
    const name = prompt('Folder name?');
    if(!name) return;
    const tree = window.__buttonsTree || {version:2, folders:[], templates:[]};
    tree.folders = Array.isArray(tree.folders) ? tree.folders : [];
    const kids = tree.folders.filter(x => x && !(x.parentId));
    const maxOrder = Math.max(-1, ...kids.map(x => Number(x.order || 0)));
    const id = _btUuid();
    tree.folders.push({id, name: String(name).trim(), parentId: null, order: maxOrder+1});
    await _btSaveTree();
    _btSetFolderOpen(id, true);
    renderButtonsTree(tree);
  });
}

const _expBtn = document.getElementById('button-folders-expand');
if(_expBtn){
  _expBtn.addEventListener('click', (ev)=>{
    ev.preventDefault();
    const tree = window.__buttonsTree;
    if(!tree || !Array.isArray(tree.folders)) return;
    tree.folders.forEach(f=>{ if(f && f.id) _btSetFolderOpen(f.id, true); });
    renderButtonsTree(tree);
  });
}
const _colBtn = document.getElementById('button-folders-collapse');
if(_colBtn){
  _colBtn.addEventListener('click', (ev)=>{
    ev.preventDefault();
    const tree = window.__buttonsTree;
    if(!tree || !Array.isArray(tree.folders)) return;
    tree.folders.forEach(f=>{ if(f && f.id) _btSetFolderOpen(f.id, false); });
    renderButtonsTree(tree);
  });
}

document.getElementById('triggers-list-ui').addEventListener('click', async (ev)=>{
  const deleteBtn = ev.target.closest('button[data-type="trigger-delete"]');
  if(deleteBtn){
    ev.preventDefault();
    ev.stopPropagation();
    const idx = deleteBtn.getAttribute('data-idx');
    if(idx === null || idx === undefined) return;
    // Deleting from the list discards current editor state; guard if dirty.
    const proceed = async () => {
      if(!confirm('Delete trigger template?')) return;
      try{
        const r = await fetch('/api/templates/trigger/' + encodeURIComponent(idx), {method:'DELETE'});
        if(!r.ok) return alert('Delete failed');
        window.__selectedTriggerIndex = null;
        await loadTemplates();
        _clearTriggerEditor();
      }catch(e){
        console.error(e);
        alert('Error deleting');
      }
    };

    if(!_tplGuardOrRun(() => { proceed(); })){
      return;
    }
    return;
  }

  const row = ev.target.closest('.list-group-item[data-idx]');
  if(!row) return;
  const idx = row.getAttribute('data-idx');
  if(idx === null || idx === undefined) return;
  _tplGuardOrRun(() => _populateTriggerEditorFromTemplate(idx));
});

document.getElementById('trigger-editor-triggers-container').addEventListener('click', (ev)=>{
  const toggle = ev.target.closest('.toggle-collapse');
  if(toggle){
    ev.preventDefault();
    const row = toggle.closest('.trigger-row');
    if(!row) return;
    const body = row.querySelector('.trigger-body');
    const tplIdx = (window.__selectedTriggerIndex !== undefined && window.__selectedTriggerIndex !== null) ? parseInt(window.__selectedTriggerIndex, 10) : null;
    const tpl = (tplIdx !== null && Array.isArray(window.__triggerTemplates)) ? window.__triggerTemplates[tplIdx] : null;
    const tplId = tpl && tpl.id ? String(tpl.id) : 'new';
    const uid = String(row.querySelector('input[name=\"uid\"]')?.value || row.getAttribute('data-uid') || '').trim();
    const key = `tplTrigCollapsed:${tplId}:${uid}`;
    const collapsed = !(body && body.style.display === 'none');
    if(body) body.style.display = collapsed ? 'none' : '';
    toggle.textContent = collapsed ? '▸' : '▾';
    try{ localStorage.setItem(key, collapsed ? '1' : '0'); }catch(e){}
    return;
  }

  const rm = ev.target.closest('.remove-trigger');
  if(rm){
    ev.preventDefault();
    const row = rm.closest('.trigger-row');
    if(row) row.remove();
    return;
  }

  const up = ev.target.closest('.move-up');
  if(up){
    ev.preventDefault();
    const row = up.closest('.trigger-row');
    if(!row || !row.parentElement) return;
    const prev = row.previousElementSibling;
    if(prev) row.parentElement.insertBefore(row, prev);
    return;
  }

  const down = ev.target.closest('.move-down');
  if(down){
    ev.preventDefault();
    const row = down.closest('.trigger-row');
    if(!row || !row.parentElement) return;
    const next = row.nextElementSibling;
    if(next) row.parentElement.insertBefore(next, row);
    return;
  }
});

// --- Tab init + navigation guards ---
_setTemplatesActiveTab(_readInitialTemplatesTab(), {pushHash: false});

document.getElementById('templates-tab-nav').addEventListener('click', (ev) => {
  const btn = ev.target && ev.target.closest ? ev.target.closest('button[data-tab]') : null;
  if(!btn) return;
  ev.preventDefault();
  const tab = String(btn.getAttribute('data-tab') || '');
  if(!tab) return;
  if(tab === _templatesActiveTab) return;

  const act = () => _setTemplatesActiveTab(tab);
  if(_templatesActiveTab === 'triggers'){
    _tplGuardOrRun(act);
  }else{
    act();
  }
});

// Track edits in the trigger-template editor.
const triggersPane = document.getElementById('templates-tab-triggers');
if(triggersPane){
  triggersPane.addEventListener('input', () => _tplScheduleDirtyRecalc(), true);
  triggersPane.addEventListener('change', () => { try{ _tplSetDirtyFlagFromUI(); }catch(e){ _tplDirty = true; } }, true);
}

// Warn on tab close / reload.
window.addEventListener('beforeunload', (e) => {
  if(_tplAllowUnloadOnce) return;
  try{ _tplSetDirtyFlagFromUI(); }catch(err){ _tplDirty = true; }
  if(!_tplDirty) return;
  e.preventDefault();
  e.returnValue = '';
  return '';
});

// Intercept in-app navigation (including switching to other pages).
document.addEventListener('click', (e) => {
  try{ _tplSetDirtyFlagFromUI(); }catch(err){ _tplDirty = true; }
  if(!_tplDirty) return;
  const a = e.target && e.target.closest ? e.target.closest('a[href]') : null;
  if(!a) return;
  const href = String(a.getAttribute('href') || '').trim();
  if(!href) return;
  if(href.startsWith('#')) return;
  if(href.toLowerCase().startsWith('javascript:')) return;
  if(e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button !== 0) return;

  try{
    const url = new URL(href, window.location.href);
    if(url.origin !== window.location.origin) return;
    e.preventDefault();
    _tplShowUnsavedPrompt(() => { window.location.href = url.href; });
  }catch(err){
    // ignore
  }
}, true);

// Seed baseline for the editor.
try{ _tplSetBaselineFromUI(); }catch(e){}

// initial load
loadTemplates();
</script>

{% endblock %}

