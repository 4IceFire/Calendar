{% extends 'base.html' %}

{% set page_title = 'Users' %}

{% block content %}
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card tdeck-soft">
        <div class="card-body">
          <h2 class="h5 mb-3">Create User</h2>
          <form method="post">
            <input type="hidden" name="_csrf" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="create_user">

            <div class="mb-3">
              <label class="form-label">Username</label>
              <input class="form-control" name="username" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input class="form-control" type="password" name="password" required>
              <div class="small text-muted mt-1">Minimum length: {{ min_len }}</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Role</label>
              <select class="form-select" name="role_id">
                <option value="">(none)</option>
                {% for r in roles %}
                  <option value="{{ r.id }}">{{ r.name }}</option>
                {% endfor %}
              </select>
            </div>

            <button class="btn btn-primary" type="submit">Add user</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card tdeck-soft">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h5 mb-0">Users</h2>
            <a class="btn btn-sm btn-outline-secondary" href="/admin/backup/authdb">Export/Backup auth.db</a>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Role</th>
                  <th>Active</th>
                  <th style="width: 1%"></th>
                </tr>
              </thead>
              <tbody>
                {% for u in users %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ u.username }}</div>
                      <div class="small text-muted">ID: {{ u.id }}</div>
                    </td>
                    <td>
                      <form method="post" class="d-flex gap-2 align-items-center">
                        <input type="hidden" name="_csrf" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="update_user">
                        <input type="hidden" name="user_id" value="{{ u.id }}">
                        <select class="form-select form-select-sm" name="role_id">
                          <option value="">(none)</option>
                          {% for r in roles %}
                            <option value="{{ r.id }}" {% if u.role_id == r.id %}selected{% endif %}>{{ r.name }}</option>
                          {% endfor %}
                        </select>
                        <div class="form-check ms-2">
                          <input class="form-check-input" type="checkbox" name="is_active" {% if u.is_active %}checked{% endif %}>
                          <label class="form-check-label">Active</label>
                        </div>
                        <button class="btn btn-sm btn-outline-primary ms-2" type="submit">Save</button>
                      </form>

                      <form method="post" class="d-flex gap-2 align-items-center mt-2">
                        <input type="hidden" name="_csrf" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="reset_password">
                        <input type="hidden" name="user_id" value="{{ u.id }}">
                        <input class="form-control form-control-sm" type="password" name="new_password" placeholder="New password">
                        <button class="btn btn-sm btn-outline-secondary" type="submit">Reset</button>
                      </form>
                    </td>
                    <td>
                      {% if u.is_active %}
                        <span class="badge text-bg-success">Yes</span>
                      {% else %}
                        <span class="badge text-bg-secondary">No</span>
                      {% endif %}
                    </td>
                    <td>
                      <form method="post">
                        <input type="hidden" name="_csrf" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="delete_user">
                        <input type="hidden" name="user_id" value="{{ u.id }}">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
