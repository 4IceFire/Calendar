{% extends 'base.html' %}

{% set page_title = 'API Reference' %}
{% set page_subtitle = 'HTTP endpoints exposed by the Web UI server' %}

{% block content %}
<div class="card">
  <div class="card-body">
    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
      <div class="text-muted small">
        Tip: In trigger editors you can type paths like <code>/videohub/ping</code>; the app will add <code>/api</code> automatically.
      </div>
      <a class="btn btn-sm btn-outline-secondary" href="/static" style="display:none"> </a>
    </div>

    <div id="api-ref-render" class="api-ref-markdown"></div>
  </div>
</div>

<style>
  .api-ref-markdown h1, .api-ref-markdown h2, .api-ref-markdown h3 { margin-top: 1.2rem; }
  .api-ref-markdown h1:first-child { margin-top: 0; }
  .api-ref-markdown pre { padding: .75rem; border-radius: .5rem; background: rgba(127,127,127,.12); }
  .api-ref-markdown code { padding: .1rem .25rem; border-radius: .25rem; background: rgba(127,127,127,.12); }
  .api-ref-markdown pre code { padding: 0; background: transparent; }
  .api-ref-markdown table { width: 100%; }
  .api-ref-markdown table th, .api-ref-markdown table td { padding: .35rem .5rem; border-bottom: 1px solid rgba(127,127,127,.25); vertical-align: top; }
  .api-ref-markdown a { text-decoration: none; }
  .api-ref-markdown a:hover { text-decoration: underline; }
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.6/dist/purify.min.js"></script>
<script>
  (function(){
    const outEl = document.getElementById('api-ref-render');
    if(!outEl) return;

    // Use JSON encoding to avoid HTML-entity escaping (e.g. &#34;) corrupting the markdown.
    const md = {{ api_reference_content | tojson }};

    // Configure marked for predictable output
    try{
      marked.setOptions({
        gfm: true,
        breaks: false,
        mangle: false,
        headerIds: true,
      });
    }catch(e){ /* ignore */ }

    let html = '';
    try{
      html = marked.parse(md);
    }catch(e){
      html = '<pre style="white-space:pre-wrap"></pre>';
    }

    // Sanitize HTML output (defense-in-depth)
    const clean = (window.DOMPurify && typeof window.DOMPurify.sanitize === 'function')
      ? window.DOMPurify.sanitize(html, {USE_PROFILES: {html: true}})
      : html;

    outEl.innerHTML = clean;
  })();
</script>
{% endblock %}
