{% extends 'base.html' %}

{% set page_title = 'Create Event' %}

{% block content %}
<div class="tdeck-soft rounded-3 p-3">
<form id="event-form">
  <div class="mb-3">
    <label class="form-label">Name</label>
    <input name="name" class="form-control" required>
  </div>
  <div class="row">
    <div class="col-md-3 mb-3">
      <label class="form-label">Date</label>
      <input type="date" name="date" class="form-control" required>
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Time</label>
      <input type="time" name="time" class="form-control" required>
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Day</label>
      <select name="day" class="form-select">
        <option>Monday</option>
        <option>Tuesday</option>
        <option>Wednesday</option>
        <option>Thursday</option>
        <option>Friday</option>
        <option>Saturday</option>
        <option>Sunday</option>
      </select>
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Repeating</label>
      <select name="repeating" class="form-select"><option value="false">No</option><option value="true">Yes</option></select>
    </div>
  </div>

  <h4>Triggers</h4>
  <div class="mb-2 d-flex gap-2 align-items-center">
    <select id="trigger-template-select" class="form-select form-select-sm" style="max-width:360px">
      <option value="">(select template)</option>
    </select>
    <button id="load-trigger-template-btn" class="btn btn-sm btn-outline-primary">Load Template</button>
    <button id="save-trigger-template-btn" class="btn btn-sm btn-outline-success" type="button" disabled>Save As Template</button>
    <button id="sort-event-triggers-by-time" class="btn btn-sm btn-outline-secondary ms-auto" type="button" title="Sort triggers by execution time (earliest first)">Sort by time</button>
  </div>
  <div id="triggers-container"></div>
  <div class="mb-3 mt-2">
    <button id="add-trigger-btn" class="btn btn-sm btn-outline-secondary">Add Trigger</button>
  </div>

  <div class="mb-3 form-check">
    <input class="form-check-input" type="checkbox" value="1" id="activeCheck" name="active" checked>
    <label class="form-check-label" for="activeCheck">Active</label>
  </div>
  <div class="mb-3">
    <button class="btn btn-primary" type="submit">Create Event</button>
    <a class="btn btn-link" href="/calendar">Cancel</a>
  </div>
</form>
</div>

<script>
function normalizeApiPath(p){
  let s = String(p || '').trim();
  if(!s) return '';
  if(s.includes('://')) return '';
  if(s.startsWith('/api/')) return s;
  if(s.startsWith('/')) return '/api' + s;
  return '/api/' + s.replace(/^\/+/, '');
}

function displayApiPath(p){
  const s = String(p || '').trim();
  if(s.startsWith('/api/')) return s.slice(4);
  return s;
}

async function loadButtonTemplates(){
  try{
    const resp = await fetch('/api/templates');
    const data = await resp.json();
    return data.buttons || [];
  }catch(e){ return []; }
}

async function loadTriggerTemplates(){
  try{
    const resp = await fetch('/api/templates?_ts=' + Date.now(), {cache: 'no-store'});
    const data = await resp.json();
    return data.triggers || [];
  }catch(e){ return []; }
}

function newTriggerRow(templates){
  const uid = (function(){
    try{ return crypto.randomUUID(); }catch(e){}
    return 'id_' + String(Date.now()) + '_' + String(Math.floor(Math.random()*1e9));
  })();
  const div = document.createElement('div');
  div.className = 'trigger-row border rounded p-2 mb-2';
  div.setAttribute('data-uid', uid);
  div.innerHTML = `
    <div class="d-flex gap-2 align-items-center">
      <button type="button" class="btn btn-sm btn-outline-secondary toggle-collapse" title="Collapse/expand" style="width:32px">▾</button>
      <input name="name" placeholder="Trigger name (optional)" class="form-control form-control-sm" style="max-width: 360px">
      <div class="ms-auto small text-muted" data-role="trigger-summary" style="white-space:nowrap"></div>
    </div>

    <input type="hidden" name="uid" value="${uid}">

    <div class="trigger-body mt-2">
      <div class="d-flex gap-2 align-items-center">
        <input name="minutes" placeholder="minutes" class="form-control form-control-sm" style="width:100px">
        <select name="typeOfTrigger" class="form-select form-select-sm" style="width:140px">
          <option value="BEFORE">Before</option>
          <option value="AT">At</option>
          <option value="AFTER">After</option>
        </select>
        <select name="actionType" class="form-select form-select-sm" style="width:160px">
          <option value="companion">Companion Button</option>
          <option value="api">API Call</option>
        </select>
        <div class="ms-auto d-flex align-items-center gap-2">
          <button type="button" class="btn btn-sm btn-outline-secondary move-up" title="Move up">↑</button>
          <button type="button" class="btn btn-sm btn-outline-secondary move-down" title="Move down">↓</button>
          <div class="form-check form-switch mb-0" title="Enable/disable this trigger">
            <input class="form-check-input" type="checkbox" name="enabled" checked>
          </div>
          <button class="btn btn-sm btn-outline-danger remove-trigger">Remove</button>
        </div>
      </div>

      <div class="mt-2 gap-2 align-items-center companion-fields" style="display:flex">
        <select name="buttonTemplate" class="form-select form-select-sm">
          <option value="">(none)</option>
          ${templates.map((t,i)=>`<option value="${i}">${t.label}</option>`).join('')}
        </select>
        <input name="buttonURL" placeholder="button URL (optional)" class="form-control form-control-sm">
        <small class="text-muted" style="white-space:nowrap" title="Companion short button format: bank/page/button">(bank/page/button, e.g. 1/2/3)</small>
      </div>

      <div class="mt-2 gap-2 align-items-start api-fields" style="display:none">
        <select name="apiMethod" class="form-select form-select-sm" style="width:120px">
          <option value="POST">POST</option>
          <option value="GET">GET</option>
          <option value="PUT">PUT</option>
          <option value="PATCH">PATCH</option>
          <option value="DELETE">DELETE</option>
        </select>
        <input name="apiPath" placeholder="/videohub/presets/1/apply" class="form-control form-control-sm">
        <textarea name="apiBody" placeholder='JSON body (optional)' class="form-control form-control-sm" rows="2" style="max-width:340px"></textarea>
      </div>
    </div>
  `;

  const minutesInput = div.querySelector('input[name="minutes"]');
  const typeSelect = div.querySelector('select[name="typeOfTrigger"]');
  const syncMinutesDisabled = ()=>{
    if(!minutesInput || !typeSelect) return;
    const type = String(typeSelect.value || 'AT').toUpperCase();
    if(type === 'AT'){
      minutesInput.value = '0';
      minutesInput.disabled = true;
    }else{
      minutesInput.disabled = false;
    }
  };
  if(typeSelect) typeSelect.addEventListener('change', syncMinutesDisabled);
  syncMinutesDisabled();

  // allow callers (edit-mode/template loader) to re-run this after populating values
  div.__syncMinutesDisabled = syncMinutesDisabled;

  const summaryEl = div.querySelector('[data-role="trigger-summary"]');
  const syncSummary = ()=>{
    if(!summaryEl || !typeSelect || !minutesInput) return;
    const typ = String(typeSelect.value || 'AT').toUpperCase();
    const mins = parseInt(String(minutesInput.value || '0'), 10);
    if(typ === 'AT'){
      summaryEl.textContent = 'At (0m)';
      return;
    }
    const m = Number.isFinite(mins) ? mins : 0;
    summaryEl.textContent = (typ === 'BEFORE') ? `Before ${m}m` : `After ${m}m`;
  };
  if(typeSelect) typeSelect.addEventListener('change', syncSummary);
  if(minutesInput) minutesInput.addEventListener('input', syncSummary);
  syncSummary();
  div.__syncSummary = syncSummary;

  // Toggle companion vs api fields
  const actionSel = div.querySelector('select[name="actionType"]');
  const companionFields = div.querySelector('.companion-fields');
  const apiFields = div.querySelector('.api-fields');
  const btnTplSel = div.querySelector('select[name="buttonTemplate"]');
  const btnUrlInp = div.querySelector('input[name="buttonURL"]');
  const syncActionFields = ()=>{
    const v = String(actionSel ? actionSel.value : 'companion').toLowerCase();
    if(v === 'api'){
      if(companionFields) companionFields.style.display = 'none';
      if(apiFields) apiFields.style.display = 'flex';
      if(btnTplSel) btnTplSel.disabled = true;
      if(btnUrlInp) btnUrlInp.disabled = true;
    }else{
      if(companionFields) companionFields.style.display = 'flex';
      if(apiFields) apiFields.style.display = 'none';
      if(btnTplSel) btnTplSel.disabled = false;
      if(btnUrlInp) btnUrlInp.disabled = false;
    }
  };
  if(actionSel) actionSel.addEventListener('change', syncActionFields);
  syncActionFields();
  div.__syncActionFields = syncActionFields;

  return div;
}

document.addEventListener('DOMContentLoaded', async ()=>{
  let editId = null;
  const templates = await loadButtonTemplates();
  const triggerTemplates = await loadTriggerTemplates();
  // populate trigger-template select
  const tplSel = document.getElementById('trigger-template-select');
  triggerTemplates.forEach((t,i)=>{ const opt = document.createElement('option'); opt.value = i; opt.text = t.label + ' — ' + (Array.isArray(t.times)?t.times.length: (t.spec? (Array.isArray(t.spec)?t.spec.length:'1'):'0')) + ' triggers'; tplSel.appendChild(opt); });
  const container = document.getElementById('triggers-container');
  const saveTplBtn = document.getElementById('save-trigger-template-btn');

  function _eventCollapseKey(uid){
    const eid = (editId && String(editId).trim()) ? String(editId).trim() : 'new';
    return `eventTrigCollapsed:${eid}:${String(uid || '').trim()}`;
  }

  function _applyCollapsed(row){
    if(!row) return;
    const body = row.querySelector('.trigger-body');
    const btn = row.querySelector('.toggle-collapse');
    const uid = String(row.querySelector('input[name="uid"]')?.value || row.getAttribute('data-uid') || '').trim();
    const key = _eventCollapseKey(uid);
    let collapsed = false;
    try{ collapsed = localStorage.getItem(key) === '1'; }catch(e){}
    if(body) body.style.display = collapsed ? 'none' : '';
    if(btn) btn.textContent = collapsed ? '▸' : '▾';
  }

  function _offsetMinutesFromRow(row){
    try{
      const type = String(row.querySelector('select[name="typeOfTrigger"]')?.value || 'AT').toUpperCase();
      const mins = parseInt(String(row.querySelector('input[name="minutes"]')?.value || '0'), 10);
      const m = Number.isFinite(mins) ? mins : 0;
      if(type === 'BEFORE') return -m;
      if(type === 'AFTER') return +m;
      return 0;
    }catch(e){
      return 0;
    }
  }

  function _sortEventTriggersByTime(){
    if(!container) return;
    const rows = Array.from(container.children || []).filter(x => x && x.classList && x.classList.contains('trigger-row'));
    if(rows.length < 2) return;

    // Ensure dependent UI state is up-to-date before sorting.
    rows.forEach(r=>{
      try{ if(typeof r.__syncMinutesDisabled === 'function') r.__syncMinutesDisabled(); }catch(e){}
      try{ if(typeof r.__syncSummary === 'function') r.__syncSummary(); }catch(e){}
    });

    const decorated = rows.map((r, i) => ({r, i, off: _offsetMinutesFromRow(r)}));
    decorated.sort((a,b) => (a.off - b.off) || (a.i - b.i));

    for(const d of decorated){
      container.appendChild(d.r);
    }
  }

  function _refreshTriggerTemplateSelect(list){
    const sel = document.getElementById('trigger-template-select');
    if(!sel) return;
    sel.innerHTML = '<option value="">(select template)</option>';
    (Array.isArray(list) ? list : []).forEach((t,i)=> {
      const opt = document.createElement('option');
      opt.value = i;
      const n = Array.isArray(t.times) ? t.times.length : (t.spec ? (Array.isArray(t.spec) ? t.spec.length : 1) : 0);
      opt.text = String(t.label || 'Template') + ' - ' + String(n) + ' triggers';
      sel.appendChild(opt);
    });
  }

  function _collectTimesFromUI(){
    const times = [];
    for(const row of container.children){
      const name = String(row.querySelector('input[name="name"]')?.value || '').trim();
      const uid = String(row.querySelector('input[name="uid"]')?.value || row.getAttribute('data-uid') || '').trim();
      let minsRaw = row.querySelector('input[name="minutes"]').value;
      const type = row.querySelector('select[name="typeOfTrigger"]').value || 'AT';
      const actionType = String(row.querySelector('select[name="actionType"]').value || 'companion').toLowerCase();
      const enabled = !!(row.querySelector('input[name="enabled"]') ? row.querySelector('input[name="enabled"]').checked : true);
      const tmplIdx = row.querySelector('select[name="buttonTemplate"]').value;
      let buttonURL = row.querySelector('input[name="buttonURL"]').value || '';

      // Minutes: required unless type==AT (AT is always saved as 0)
      if(String(type).toUpperCase() === 'AT'){
        minsRaw = '0';
        const mi = row.querySelector('input[name="minutes"]');
        if(mi){ mi.value = '0'; mi.disabled = true; }
      }else if((minsRaw === null || minsRaw === undefined || String(minsRaw).trim() === '')){
        throw new Error('Minutes required for non-AT triggers');
      }
      const mins = parseInt(minsRaw,10);
      if(Number.isNaN(mins) || mins < 0){ throw new Error('Minutes must be a non-negative integer'); }

      if(actionType === 'api'){
        const method = String(row.querySelector('select[name="apiMethod"]').value || 'POST').toUpperCase();
        const path = String(row.querySelector('input[name="apiPath"]').value || '').trim();
        const bodyRaw = String(row.querySelector('textarea[name="apiBody"]').value || '').trim();
        const normPath = normalizeApiPath(path);
        if(!normPath || !normPath.startsWith('/api/')){ throw new Error('API path must be like /videohub/... (the /api prefix is added automatically)'); }
        let body = undefined;
        if(bodyRaw){
          try{ body = JSON.parse(bodyRaw); }
          catch(e){ throw new Error('API body must be valid JSON'); }
        }
        const api = {method, path: normPath};
        if(body !== undefined) api.body = body;
        times.push({uid, name, minutes: mins, typeOfTrigger: type, enabled, actionType: 'api', api});
        continue;
      }

      // If a template selected, use its buttonURL (and ignore user input)
      if(tmplIdx !== ''){
        const t = templates[parseInt(tmplIdx,10)];
        if(t){
          if(t.buttonURL) buttonURL = t.buttonURL;
          else if(t.pattern && /^\d+\/\d+\/\d+$/.test(t.pattern)) buttonURL = `location/${t.pattern}/press`;
        }
      }

      // buttonURL must be present and valid now
      if(!buttonURL || buttonURL.trim() === ''){ throw new Error('Each trigger must have a button template selected or a valid button URL'); }
      // allow short form or full, but normalize short here into full
      if(/^\d+\/\d+\/\d+$/.test(buttonURL)){
        buttonURL = `location/${buttonURL}/press`;
      } else if(!/^location\/\d+\/\d+\/\d+\/press$/.test(buttonURL)){
        throw new Error('buttonURL must be like "1/2/3" or "location/1/2/3/press"');
      }

      times.push({uid, name, minutes: mins, typeOfTrigger: type, enabled, actionType: 'companion', buttonURL});
    }
    return times;
  }

  // detect edit mode from URL: /calendar/edit/<id>
  const m = window.location.pathname.match(/\/calendar\/edit\/(\d+)$/);
  if(m){
    editId = m[1];
    // switch UI to edit mode and fetch event
    const titleEl = document.getElementById('page-title') || document.querySelector('h1');
    if(titleEl) titleEl.textContent = 'Edit Event';
    const submitBtn = document.querySelector('button[type="submit"]');
    if(submitBtn) submitBtn.textContent = 'Save Changes';
    try{
      const resp = await fetch('/api/events/' + encodeURIComponent(editId) + '?_ts=' + Date.now(), {cache: 'no-store'});
      if(resp.ok){
        const ev = await resp.json();
        // fill form fields
        document.querySelector('input[name="name"]').value = ev.name || '';
        document.querySelector('input[name="date"]').value = ev.date || '';
        document.querySelector('input[name="time"]').value = ev.time || '';
        const daySel = document.querySelector('select[name="day"]'); if(daySel) daySel.value = ev.day || 'Monday';
        const repSel = document.querySelector('select[name="repeating"]'); if(repSel) repSel.value = ev.repeating ? 'true' : 'false';
        document.getElementById('activeCheck').checked = !!ev.active;

        // populate triggers
        container.innerHTML = '';
        for(const t of (ev.times || [])){
          const row = newTriggerRow(templates);
          row.querySelector('input[name="name"]').value = String((t && t.name) ? t.name : '');
          if(t && t.uid){
            const uidEl = row.querySelector('input[name="uid"]');
            if(uidEl) uidEl.value = String(t.uid);
            row.setAttribute('data-uid', String(t.uid));
          }
          row.querySelector('input[name="minutes"]').value = t.minutes;
          row.querySelector('select[name="typeOfTrigger"]').value = t.typeOfTrigger;
          row.querySelector('select[name="actionType"]').value = (t.actionType || 'companion');
          const en = (t && t.enabled !== false);
          const enInput = row.querySelector('input[name="enabled"]');
          if(enInput) enInput.checked = !!en;
          if(typeof row.__syncActionFields === 'function') row.__syncActionFields();
          if(typeof row.__syncMinutesDisabled === 'function') row.__syncMinutesDisabled();
          if(typeof row.__syncSummary === 'function') row.__syncSummary();
          _applyCollapsed(row);

          if(String(t.actionType || 'companion').toLowerCase() === 'api'){
            row.querySelector('select[name="apiMethod"]').value = (t.api && t.api.method) ? String(t.api.method).toUpperCase() : 'POST';
            row.querySelector('input[name="apiPath"]').value = (t.api && t.api.path) ? displayApiPath(String(t.api.path)) : '';
            row.querySelector('textarea[name="apiBody"]').value = (t.api && t.api.body !== undefined) ? JSON.stringify(t.api.body) : '';
          }else{
            // attempt to match a button template
            let matched = false;
            for(let bi=0; bi<templates.length; bi++){
              const b = templates[bi];
              const bu = b.buttonURL || (b.pattern?`location/${b.pattern}/press`:null);
                if(bu && bu === t.buttonURL){
                  const m2 = bu.match(/^location\/(\d+\/\d+\/\d+)\/press$/);
                  // always display the short pattern (e.g. "1/0/1") when a template is used
                  const short = m2 ? m2[1] : ((bu.match(/(\d+\/\d+\/\d+)/) || [null, null])[1] || bu);
                  row.querySelector('select[name="buttonTemplate"]').value = bi;
                  row.querySelector('input[name="buttonURL"]').value = short;
                  row.querySelector('input[name="buttonURL"]').disabled = true;
                  matched = true; break;
                }
            }
            if(!matched){
              const bu = t.buttonURL || '';
              const m2 = bu.match(/^location\/(\d+\/\d+\/\d+)\/press$/);
              row.querySelector('input[name="buttonURL"]').value = m2 ? m2[1] : (/^\d+\/\d+\/\d+$/.test(bu) ? bu : '');
            }
          }
          container.appendChild(row);
        }
      }
    }catch(e){ console.error('Failed loading event for edit', e); }
  }

  // Enable "Save As Template" only when editing an existing event.
  if(saveTplBtn) saveTplBtn.disabled = !editId;
  if(saveTplBtn){
    saveTplBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      if(!editId) return;
      try{
        const times = _collectTimesFromUI();
        if(!times.length){ alert('This event has no triggers to save.'); return; }
        const defaultLabel = String(document.querySelector('input[name="name"]').value || '').trim() || `Event ${editId}`;
        const label = String(prompt('Trigger template label:', defaultLabel) || '').trim();
        if(!label) return;

        const r = await fetch('/api/templates/trigger', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({label, times}),
        });
        const data = await r.json().catch(() => ({}));
        if(!r.ok || !data.ok){
          throw new Error((data && data.error) ? data.error : 'Save failed');
        }

        const all = await fetch('/api/templates?_ts=' + Date.now(), {cache: 'no-store'}).then(r => r.json()).catch(() => ({}));
        _refreshTriggerTemplateSelect(all.triggers || []);
        alert('Saved trigger template.');
      }catch(e){
        alert('Failed to save trigger template: ' + String(e.message || e));
      }
    });
  }

  document.getElementById('add-trigger-btn').addEventListener('click', (ev)=>{
    ev.preventDefault();
    const row = newTriggerRow(templates);
    container.appendChild(row);
    if(typeof row.__syncSummary === 'function') row.__syncSummary();
    _applyCollapsed(row);
  });

  const sortBtn = document.getElementById('sort-event-triggers-by-time');
  if(sortBtn){
    sortBtn.addEventListener('click', (ev)=>{
      ev.preventDefault();
      _sortEventTriggersByTime();
    });
  }

  container.addEventListener('click', (ev)=>{
    const toggle = ev.target.closest('.toggle-collapse');
    if(toggle){
      ev.preventDefault();
      const row = toggle.closest('.trigger-row');
      if(!row) return;
      const body = row.querySelector('.trigger-body');
      const uid = String(row.querySelector('input[name="uid"]')?.value || row.getAttribute('data-uid') || '').trim();
      const key = _eventCollapseKey(uid);
      const collapsed = !(body && body.style.display === 'none');
      if(body) body.style.display = collapsed ? 'none' : '';
      toggle.textContent = collapsed ? '▸' : '▾';
      try{ localStorage.setItem(key, collapsed ? '1' : '0'); }catch(e){}
      return;
    }

    const up = ev.target.closest('.move-up');
    if(up){
      ev.preventDefault();
      const row = up.closest('.trigger-row');
      if(!row || !row.parentElement) return;
      const prev = row.previousElementSibling;
      if(prev) row.parentElement.insertBefore(row, prev);
      return;
    }

    const down = ev.target.closest('.move-down');
    if(down){
      ev.preventDefault();
      const row = down.closest('.trigger-row');
      if(!row || !row.parentElement) return;
      const next = row.nextElementSibling;
      if(next) row.parentElement.insertBefore(next, row);
      return;
    }

    const btn = ev.target.closest('.remove-trigger');
    if(!btn) return;
    const row = btn.closest('.trigger-row');
    if(row) row.remove();
  });

  // when a button template is selected, auto-fill and disable the buttonURL input
  container.addEventListener('change', (ev)=>{
    const sel = ev.target.closest('select[name="buttonTemplate"]');
    if(!sel) return;
    const row = sel.closest('.trigger-row');
    const actionSel = row.querySelector('select[name="actionType"]');
    if(actionSel && String(actionSel.value || 'companion').toLowerCase() === 'api') return;
    const idx = sel.value;
    const input = row.querySelector('input[name="buttonURL"]');
    if(idx !== ''){
      const tpl = templates[parseInt(idx,10)];
      if(tpl){
          let bu = tpl.buttonURL;
          if(!bu && tpl.pattern && /^\d+\/\d+\/\d+$/.test(tpl.pattern)) bu = `location/${tpl.pattern}/press`;
          if(bu){
            // show short form (e.g. "1/0/1") in the input, disable editing
            const m = bu.match(/^location\/(\d+\/\d+\/\d+)\/press$/);
            const short = m ? m[1] : ((bu.match(/(\d+\/\d+\/\d+)/) || [null, null])[1] || '');
            input.value = short;
            input.disabled = true;
          } else {
            input.disabled = false;
            input.value = '';
          }
      }
    }else{
      input.disabled = false;
      input.value = '';
    }
  });

  // load template into the triggers container (replaces current rows)
  document.getElementById('load-trigger-template-btn').addEventListener('click', async (ev)=>{
    ev.preventDefault();
    const sel = document.getElementById('trigger-template-select');
    const idx = sel.value;
    if(!idx) return alert('Select a trigger template first');
    // ensure we have fresh templates
    const all = await fetch('/api/templates?_ts=' + Date.now(), {cache: 'no-store'}).then(r=>r.json());
    const triggers = all.triggers || [];
    const tpl = triggers[parseInt(idx,10)];
    if(!tpl) return alert('Template not found');
    const times = Array.isArray(tpl.times) ? tpl.times : (tpl.times ? JSON.parse(tpl.times) : []);
    // clear existing
    container.innerHTML = '';
    // for each time, create a row and populate values
    for(const t of times){
      const row = newTriggerRow(templates);
      row.querySelector('input[name="name"]').value = String((t && t.name) ? t.name : '');
      if(t && t.uid){
        const uidEl = row.querySelector('input[name="uid"]');
        if(uidEl) uidEl.value = String(t.uid);
        row.setAttribute('data-uid', String(t.uid));
      }
      row.querySelector('input[name="minutes"]').value = t.minutes;
      row.querySelector('select[name="typeOfTrigger"]').value = t.typeOfTrigger;
      row.querySelector('select[name="actionType"]').value = (t.actionType || 'companion');
      const en = (t && t.enabled !== false);
      const enInput = row.querySelector('input[name="enabled"]');
      if(enInput) enInput.checked = !!en;
      if(typeof row.__syncActionFields === 'function') row.__syncActionFields();
      if(typeof row.__syncMinutesDisabled === 'function') row.__syncMinutesDisabled();
      if(typeof row.__syncSummary === 'function') row.__syncSummary();
      _applyCollapsed(row);

      if(String(t.actionType || 'companion').toLowerCase() === 'api'){
        row.querySelector('select[name="apiMethod"]').value = (t.api && t.api.method) ? String(t.api.method).toUpperCase() : 'POST';
        row.querySelector('input[name="apiPath"]').value = (t.api && t.api.path) ? displayApiPath(String(t.api.path)) : '';
        row.querySelector('textarea[name="apiBody"]').value = (t.api && t.api.body !== undefined) ? JSON.stringify(t.api.body) : '';
      }else{
        // try to match button template
        let matched = false;
        for(let bi=0; bi<templates.length; bi++){
          const b = templates[bi];
          const bu = b.buttonURL || (b.pattern?`location/${b.pattern}/press`:null);
            if(bu && bu === t.buttonURL){
              // display short form when populating from template
              const m = bu.match(/^location\/(\d+\/\d+\/\d+)\/press$/);
              const short = m ? m[1] : ((bu.match(/(\d+\/\d+\/\d+)/) || [null, null])[1] || '');
              row.querySelector('select[name="buttonTemplate"]').value = bi;
              row.querySelector('input[name="buttonURL"]').value = short;
              row.querySelector('input[name="buttonURL"]').disabled = true;
              matched = true; break; }
        }
        if(!matched){
          const bu = t.buttonURL || '';
          const m = bu.match(/^location\/(\d+\/\d+\/\d+)\/press$/);
          row.querySelector('input[name="buttonURL"]') .value = m ? m[1] : (/^\d+\/\d+\/\d+$/.test(bu) ? bu : '');
        }
      }
      container.appendChild(row);
    }
  });

  // initialize any pre-selected templates on page load
  (function initSelectedTemplates(){
    for(const row of container.children){
      const actionSel = row.querySelector('select[name="actionType"]');
      if(actionSel && String(actionSel.value || 'companion').toLowerCase() === 'api') continue;
      const sel = row.querySelector('select[name="buttonTemplate"]');
      const input = row.querySelector('input[name="buttonURL"]');
      if(!sel || !input) continue;
      const idx = sel.value;
      if(idx !== ''){
        const tpl = templates[parseInt(idx,10)];
        if(tpl){
          let bu = tpl.buttonURL;
          if(!bu && tpl.pattern && /^\d+\/\d+\/\d+$/.test(tpl.pattern)) bu = `location/${tpl.pattern}/press`;
          if(bu){
            const m = bu.match(/^location\/(\d+\/\d+\/\d+)\/press$/);
            const short = m ? m[1] : ((bu.match(/(\d+\/\d+\/\d+)/) || [null, null])[1] || '');
            input.value = short; input.disabled = true;
          }
        }
      }
    }
  })();

  document.getElementById('event-form').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const form = ev.target;
    const formData = new FormData(form);
    const name = formData.get('name');
    const date = formData.get('date');
    const time = formData.get('time');
    const day = formData.get('day');
    const repeating = formData.get('repeating') === 'true';

    let times = [];
    try{
      times = _collectTimesFromUI();
    }catch(e){
      alert(String((e && e.message) || e || 'Invalid trigger(s)'));
      return;
    }

    const active = document.getElementById('activeCheck').checked === true;
    const payload = {name, date, time, day, repeating, active: active, times};
    try{
      let url = '/api/ui/events';
      let method = 'POST';
      if(typeof editId !== 'undefined' && editId){ url = '/api/events/' + encodeURIComponent(editId); method = 'PUT'; }
      const resp = await fetch(url, {method:method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if(resp.ok){
        alert(editId ? 'Saved' : 'Created');
        window.location.href = '/calendar';
      }else{
        const txt = await resp.text();
        alert((editId ? 'Save' : 'Create') + ' failed: ' + txt);
      }
    }catch(e){ console.error(e); alert((editId ? 'Save' : 'Error creating') + ' event'); }
  });
});
</script>

{% endblock %}
